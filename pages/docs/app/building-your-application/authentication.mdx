---
title: Authentication
description: Learn how to implement authentication in your Next.js application.
---

# Authentication

ì¸ì¦ì„ ì´í•´í•˜ëŠ” ê²ƒì€ ì• í”Œë¦¬ì¼€ì´ì…˜ì˜ ë°ì´í„°ë¥¼ ë³´í˜¸í•˜ëŠ” ë° ë§¤ìš° ì¤‘ìš”í•©ë‹ˆë‹¤. ì´ í˜ì´ì§€ì—ì„œëŠ” ì¸ì¦ì„ êµ¬í˜„í•˜ê¸° ìœ„í•´ React ë° Next.js ê¸°ëŠ¥ì„ ì‚¬ìš©í•˜ëŠ” ë°©ë²•ì„ ì•ˆë‚´í•©ë‹ˆë‹¤.

ì‹œì‘í•˜ê¸° ì „ì— í”„ë¡œì„¸ìŠ¤ë¥¼ ì„¸ ê°€ì§€ ê°œë…ìœ¼ë¡œ ë‚˜ëˆ„ë©´ ë„ì›€ì´ ë©ë‹ˆë‹¤:

1. **[Authentication](#authentication)**: ì‚¬ìš©ìê°€ ìì‹ ì´ ì£¼ì¥í•˜ëŠ” ì‚¬ëŒì¸ì§€ í™•ì¸í•©ë‹ˆë‹¤. ì‚¬ìš©ìì—ê²Œ ì‚¬ìš©ì ì´ë¦„ê³¼ ë¹„ë°€ë²ˆí˜¸ì™€ ê°™ì€ ê²ƒì„ ìš”êµ¬í•˜ì—¬ ì‹ ì›ì„ ì¦ëª…í•˜ê²Œ í•©ë‹ˆë‹¤.
2. **[Session Management](#session-management)**: ìš”ì²­ ê°„ì— ì‚¬ìš©ìì˜ ì¸ì¦ ìƒíƒœë¥¼ ì¶”ì í•©ë‹ˆë‹¤.
3. **[Authorization](#authorization)**: ì‚¬ìš©ìê°€ ì ‘ê·¼í•  ìˆ˜ ìˆëŠ” ë¼ìš°íŠ¸ì™€ ë°ì´í„°ë¥¼ ê²°ì •í•©ë‹ˆë‹¤.

ë‹¤ìŒ ë‹¤ì´ì–´ê·¸ë¨ì€ React ë° Next.js ê¸°ëŠ¥ì„ ì‚¬ìš©í•œ ì¸ì¦ íë¦„ì„ ë³´ì—¬ì¤ë‹ˆë‹¤:

<Image
  alt="Diagram showing the authentication flow with React and Next.js features"
  srcLight="/docs/light/authentication-overview.png"
  srcDark="/docs/dark/authentication-overview.png"
  width="1600"
  height="1383"
/>

ì´ í˜ì´ì§€ì˜ ì˜ˆì œëŠ” êµìœ¡ ëª©ì ìœ¼ë¡œ ê¸°ë³¸ì ì¸ ì‚¬ìš©ì ì´ë¦„ê³¼ ë¹„ë°€ë²ˆí˜¸ ì¸ì¦ì„ ì„¤ëª…í•©ë‹ˆë‹¤. ì‚¬ìš©ì ì •ì˜ ì¸ì¦ ì†”ë£¨ì…˜ì„ êµ¬í˜„í•  ìˆ˜ë„ ìˆì§€ë§Œ, ë³´ì•ˆì„±ê³¼ ë‹¨ìˆœì„±ì„ ë†’ì´ê¸° ìœ„í•´ ì¸ì¦ ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ì‚¬ìš©í•˜ëŠ” ê²ƒì´ ì¢‹ìŠµë‹ˆë‹¤. ì´ëŸ¬í•œ ë¼ì´ë¸ŒëŸ¬ë¦¬ëŠ” ì¸ì¦, ì„¸ì…˜ ê´€ë¦¬ ë° ê¶Œí•œ ë¶€ì—¬ì— ëŒ€í•œ ë‚´ì¥ ì†”ë£¨ì…˜ì„ ì œê³µí•˜ë©° ì†Œì…œ ë¡œê·¸ì¸, ë‹¤ì¤‘ ì¸ì¦ ë° ì—­í•  ê¸°ë°˜ ì•¡ì„¸ìŠ¤ ì œì–´ì™€ ê°™ì€ ì¶”ê°€ ê¸°ëŠ¥ë„ ì œê³µí•©ë‹ˆë‹¤. [Auth Libraries](#auth-libraries) ì„¹ì…˜ì—ì„œ ë¼ì´ë¸ŒëŸ¬ë¦¬ ëª©ë¡ì„ ì°¾ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

## Authentication

<AppOnly>

### íšŒì›ê°€ì… ë° ë¡œê·¸ì¸ ê¸°ëŠ¥

[`<form>`](https://react.dev/reference/react-dom/components/form) ìš”ì†Œì™€ Reactì˜ [Server Actions](/docs/app/building-your-application/data-fetching/server-actions-and-mutations) ë° [`useActionState()`](https://react.dev/reference/react/useActionState)ë¥¼ ì‚¬ìš©í•˜ì—¬ ì‚¬ìš©ì ìê²© ì¦ëª…ì„ ìº¡ì²˜í•˜ê³ , ì–‘ì‹ í•„ë“œë¥¼ ê²€ì¦í•˜ë©°, ì¸ì¦ ì œê³µìì˜ API ë˜ëŠ” ë°ì´í„°ë² ì´ìŠ¤ë¥¼ í˜¸ì¶œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ì„œë²„ ì•¡ì…˜ì€ í•­ìƒ ì„œë²„ì—ì„œ ì‹¤í–‰ë˜ë¯€ë¡œ ì¸ì¦ ë¡œì§ì„ ì²˜ë¦¬í•˜ê¸°ì— ì•ˆì „í•œ í™˜ê²½ì„ ì œê³µí•©ë‹ˆë‹¤.

ë‹¤ìŒì€ íšŒì›ê°€ì…/ë¡œê·¸ì¸ ê¸°ëŠ¥ì„ êµ¬í˜„í•˜ëŠ” ë‹¨ê³„ì…ë‹ˆë‹¤:

#### 1. ì‚¬ìš©ì ìê²© ì¦ëª… ìº¡ì²˜

ì‚¬ìš©ì ìê²© ì¦ëª…ì„ ìº¡ì²˜í•˜ë ¤ë©´, ì œì¶œ ì‹œ ì„œë²„ ì•¡ì…˜ì„ í˜¸ì¶œí•˜ëŠ” ì–‘ì‹ì„ ë§Œë“­ë‹ˆë‹¤. ì˜ˆë¥¼ ë“¤ì–´, ì‚¬ìš©ìì˜ ì´ë¦„, ì´ë©”ì¼ ë° ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥ë°›ëŠ” íšŒì›ê°€ì… ì–‘ì‹ì…ë‹ˆë‹¤:

```tsx filename="app/ui/signup-form.tsx" switcher
import { signup } from "@/app/actions/auth";

export function SignupForm() {
  return (
    <form action={signup}>
      <div>
        <label htmlFor="name">Name</label>
        <input id="name" name="name" placeholder="Name" />
      </div>
      <div>
        <label htmlFor="email">Email</label>
        <input id="email" name="email" type="email" placeholder="Email" />
      </div>
      <div>
        <label htmlFor="password">Password</label>
        <input id="password" name="password" type="password" />
      </div>
      <button type="submit">Sign Up</button>
    </form>
  );
}
```

```jsx filename="app/ui/signup-form.js" switcher
import { signup } from "@/app/actions/auth";

export function SignupForm() {
  return (
    <form action={signup}>
      <div>
        <label htmlFor="name">Name</label>
        <input id="name" name="name" placeholder="Name" />
      </div>
      <div>
        <label htmlFor="email">Email</label>
        <input id="email" name="email" type="email" placeholder="Email" />
      </div>
      <div>
        <label htmlFor="password">Password</label>
        <input id="password" name="password" type="password" />
      </div>
      <button type="submit">Sign Up</button>
    </form>
  );
}
```

```tsx filename="app/actions/auth.tsx" switcher
export async function signup(formData: FormData) {}
```

```jsx filename="app/actions/auth.js" switcher
export async function signup(formData) {}
```

#### 2. ì„œë²„ì—ì„œ ì–‘ì‹ í•„ë“œ ê²€ì¦

ì„œë²„ ì•¡ì…˜ì„ ì‚¬ìš©í•˜ì—¬ ì„œë²„ì—ì„œ ì–‘ì‹ í•„ë“œë¥¼ ê²€ì¦í•©ë‹ˆë‹¤. ì¸ì¦ ì œê³µìê°€ ì–‘ì‹ ê²€ì¦ì„ ì œê³µí•˜ì§€ ì•ŠëŠ” ê²½ìš° [Zod](https://zod.dev/) ë˜ëŠ” [Yup](https://github.com/jquense/yup)ì™€ ê°™ì€ ìŠ¤í‚¤ë§ˆ ê²€ì¦ ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

Zodë¥¼ ì˜ˆë¡œ ë“¤ì–´ ì ì ˆí•œ ì˜¤ë¥˜ ë©”ì‹œì§€ì™€ í•¨ê»˜ ì–‘ì‹ ìŠ¤í‚¤ë§ˆë¥¼ ì •ì˜í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:

```ts filename="app/lib/definitions.ts" switcher
import { z } from "zod";

export const SignupFormSchema = z.object({
  name: z
    .string()
    .min(2, { message: "Name must be at least 2 characters long." })
    .trim(),
  email: z.string().email({ message: "Please enter a valid email." }).trim(),
  password: z
    .string()
    .min(8, { message: "Be at least 8 characters long" })
    .regex(/[a-zA-Z]/, { message: "Contain at least one letter." })
    .regex(/[0-9]/, { message: "Contain at least one number." })
    .regex(/[^a-zA-Z0-9]/, {
      message: "Contain at least one special character.",
    })
    .trim(),
});

export type FormState =
  | {
      errors?: {
        name?: string[];
        email?: string[];
        password?: string[];
      };
      message?: string;
    }
  | undefined;
```

```js filename="app/lib/definitions.js" switcher
import { z } from "zod";

export const SignupFormSchema = z.object({
  name: z
    .string()
    .min(2, { message: "Name must be at least 2 characters long." })
    .trim(),
  email: z.string().email({ message: "Please enter a valid email." }).trim(),
  password: z
    .string()
    .min(8, { message: "Be at least 8 characters long" })
    .regex(/[a-zA-Z]/, { message: "Contain at least one letter." })
    .regex(/[0-9]/, { message: "Contain at least one number." })
    .regex(/[^a-zA-Z0-9]/, {
      message: "Contain at least one special character.",
    })
    .trim(),
});
```

ì–‘ì‹ í•„ë“œê°€ ì •ì˜ëœ ìŠ¤í‚¤ë§ˆì™€ ì¼ì¹˜í•˜ì§€ ì•Šìœ¼ë©´ ì„œë²„ ì•¡ì…˜ì—ì„œ ì¡°ê¸°ì— ë°˜í™˜í•˜ì—¬ ì¸ì¦ ì œê³µìì˜ API ë˜ëŠ” ë°ì´í„°ë² ì´ìŠ¤ í˜¸ì¶œì„ ë°©ì§€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

```ts filename="app/actions/auth.ts" switcher
import { SignupFormSchema, FormState } from "@/app/lib/definitions";

export async function signup(state: FormState, formData: FormData) {
  // ì–‘ì‹ í•„ë“œ ê²€ì¦
  const validatedFields = SignupFormSchema.safeParse({
    name: formData.get("name"),
    email: formData.get("email"),
    password: formData.get("password"),
  });

  // ì–‘ì‹ í•„ë“œê°€ ìœ íš¨í•˜ì§€ ì•Šìœ¼ë©´ ì¡°ê¸°ì— ë°˜í™˜
  if (!validatedFields.success) {
    return {
      errors: validatedFields.error.flatten().fieldErrors,
    };
  }

  // ì œê³µì ë˜ëŠ” ë°ì´í„°ë² ì´ìŠ¤ë¥¼ í˜¸ì¶œí•˜ì—¬ ì‚¬ìš©ì ìƒì„±...
}
```

```js filename="app/actions/auth.js" switcher
import { SignupFormSchema } from "@/app/lib/definitions";

export async function signup(state, formData) {
  // ì–‘ì‹ í•„ë“œ ê²€ì¦
  const validatedFields = SignupFormSchema.safeParse({
    name: formData.get("name"),
    email: formData.get("email"),
    password: formData.get("password"),
  });

  // ì–‘ì‹ í•„ë“œê°€ ìœ íš¨í•˜ì§€ ì•Šìœ¼ë©´ ì¡°ê¸°ì— ë°˜í™˜
  if (!validatedFields.success) {
    return {
      errors: validatedFields.error.flatten().fieldErrors,
    };
  }

  // ì œê³µì ë˜ëŠ” ë°ì´í„°ë² ì´ìŠ¤ë¥¼ í˜¸ì¶œí•˜ì—¬ ì‚¬ìš©ì ìƒì„±...
}
```

ì´ì œ `<SignupForm />`ì—ì„œ Reactì˜ `useActionState()` í›…ì„ ì‚¬ìš©í•˜ì—¬ ìœ íš¨ì„± ê²€ì‚¬ ì˜¤ë¥˜ì™€ ì–‘ì‹ ì œì¶œ ì¤‘ ëŒ€ê¸° ìƒíƒœë¥¼ í‘œì‹œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:

```tsx filename="app/ui/signup-form.tsx" switcher highlight={7,15,21,27-39}
"use client";

import { useActionState } from "react";
import { signup } from "@/app/actions/auth";

export function SignupForm() {
  const [state, action, pending] = useActionState(signup, undefined);

  return (
    <form action={action}>
      <div>
        <label htmlFor="name">Name</label>
        <input id="name" name="name" placeholder="Name" />
      </div>
      {state?.errors?.name && <p>{state.errors.name}</p>}

      <div>
        <label htmlFor="email">Email</label>
        <input id="email" name="email" placeholder="Email" />
      </div>
      {state?.errors?.email && <p>{state.errors.email}</p>}

      <div>
        <label htmlFor="password">Password</label>
        <input id="password" name="password" type="password" />
      </div>
      {state?.errors?.password && (
        <div>
          <p>Password must:</p>
          <ul>
            {state.errors.password.map((error) => (
              <li key={error}>- {error}</li>
            ))}
          </ul>
        </div>
      )}
      <button aria-disabled={pending} type="submit">
        {pending ? "Submitting..." : "Sign up"}
      </button>
    </form>
  );
}
```

```jsx filename="app/ui/signup-form.js" switcher highlight={7,15,21,27-39}
"use client";

import { useActionState } from "react";
import { signup } from "@/app/actions/auth";

export function SignupForm() {
  const [state, action, pending] = useActionState(signup, undefined);

  return (
    <form action={action}>
      <div>
        <label htmlFor="name">Name</label>
        <input id="name" name="name" placeholder="John Doe" />
      </div>
      {state.errors.name && <p>{state.errors.name}</p>}

      <div>
        <label htmlFor="email">Email</label>
        <input id="email" name="email" placeholder="john@example.com" />
      </div>
      {state.errors.email && <p>{state.errors.email}</p>}

      <div>
        <label htmlFor="password">Password</label>
        <input id="password" name="password" type="password" />
      </div>
      {state.errors.password && (
        <div>
          <p>Password must:</p>
          <ul>
            {state.errors.password.map((error) => (
              <li key={error}>- {error}</li>
            ))}
          </ul>
        </div>
      )}
      <button aria-disabled={pending} type="submit">
        {pending ? "Submitting..." : "Sign up"}
      </button>
    </form>
  );
}
```

> **ìœ ìš©í•œ ì •ë³´:** ëŒ€ê¸° ìƒíƒœë¥¼ í‘œì‹œí•˜ë ¤ë©´ [`useFormStatus`](https://react.dev/reference/react-dom/hooks/useFormStatus) í›…ì„ ì‚¬ìš©í•  ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤.

#### 3. Create a user or check user credentials

ì–‘ì‹ í•„ë“œë¥¼ ê²€ì¦í•œ í›„, ì¸ì¦ ì œê³µìì˜ API ë˜ëŠ” ë°ì´í„°ë² ì´ìŠ¤ë¥¼ í˜¸ì¶œí•˜ì—¬ ìƒˆ ì‚¬ìš©ì ê³„ì •ì„ ìƒì„±í•˜ê±°ë‚˜ ì‚¬ìš©ìê°€ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ì´ì „ ì˜ˆì œì—ì„œ ê³„ì† ì§„í–‰í•©ë‹ˆë‹¤:

```tsx filename="app/actions/auth.tsx" switcher
export async function signup(state: FormState, formData: FormData) {
  // 1. Validate form fields
  // ...

  // 2. Prepare data for insertion into database
  const { name, email, password } = validatedFields.data;
  // e.g. Hash the user's password before storing it
  const hashedPassword = await bcrypt.hash(password, 10);

  // 3. Insert the user into the database or call an Auth Library's API
  const data = await db
    .insert(users)
    .values({
      name,
      email,
      password: hashedPassword,
    })
    .returning({ id: users.id });

  const user = data[0];

  if (!user) {
    return {
      message: "An error occurred while creating your account.",
    };
  }

  // TODO:
  // 4. Create user session
  // 5. Redirect user
}
```

```jsx filename="app/actions/auth.js" switcher
export async function signup(state, formData) {
  // 1. Validate form fields
  // ...

  // 2. Prepare data for insertion into database
  const { name, email, password } = validatedFields.data;
  // e.g. Hash the user's password before storing it
  const hashedPassword = await bcrypt.hash(password, 10);

  // 3. Insert the user into the database or call an Library API
  const data = await db
    .insert(users)
    .values({
      name,
      email,
      password: hashedPassword,
    })
    .returning({ id: users.id });

  const user = data[0];

  if (!user) {
    return {
      message: "An error occurred while creating your account.",
    };
  }

  // TODO:
  // 4. Create user session
  // 5. Redirect user
}
```

ì‚¬ìš©ì ê³„ì •ì„ ì„±ê³µì ìœ¼ë¡œ ìƒì„±í•˜ê±°ë‚˜ ì‚¬ìš©ì ìê²© ì¦ëª…ì„ í™•ì¸í•œ í›„, ì‚¬ìš©ìì˜ ì¸ì¦ ìƒíƒœë¥¼ ê´€ë¦¬í•˜ê¸° ìœ„í•´ ì„¸ì…˜ì„ ìƒì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì„¸ì…˜ ê´€ë¦¬ ì „ëµì— ë”°ë¼ ì„¸ì…˜ì€ ì¿ í‚¤ ë˜ëŠ” ë°ì´í„°ë² ì´ìŠ¤, ë˜ëŠ” ë‘˜ ë‹¤ì— ì €ì¥ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤. [Session Management](#session-management) ì„¹ì…˜ì—ì„œ ë” ë§ì€ ë‚´ìš©ì„ ê³„ì† ì½ì–´ë³´ì„¸ìš”.

> **íŒ:**
>
> - ìœ„ ì˜ˆì œëŠ” êµìœ¡ ëª©ì ìœ¼ë¡œ ì¸ì¦ ë‹¨ê³„ë¥¼ ìì„¸íˆ ì„¤ëª…í•˜ë¯€ë¡œ ë‹¤ì†Œ ì¥í™©í•©ë‹ˆë‹¤. ì´ëŠ” ìì²´ì ìœ¼ë¡œ ì•ˆì „í•œ ì†”ë£¨ì…˜ì„ êµ¬í˜„í•˜ëŠ” ê²ƒì´ ì–¼ë§ˆë‚˜ ë³µì¡í•´ì§ˆ ìˆ˜ ìˆëŠ”ì§€ë¥¼ ê°•ì¡°í•©ë‹ˆë‹¤. ì¸ì¦ ê³¼ì •ì„ ë‹¨ìˆœí™”í•˜ê¸° ìœ„í•´ [Auth Library](#auth-libraries)ë¥¼ ì‚¬ìš©í•˜ëŠ” ê²ƒì„ ê³ ë ¤í•˜ì„¸ìš”.
> - ì‚¬ìš©ì ê²½í—˜ì„ ê°œì„ í•˜ê¸° ìœ„í•´, ë“±ë¡ ê³¼ì •ì—ì„œ ì´ë©”ì¼ ë˜ëŠ” ì‚¬ìš©ì ì´ë¦„ì˜ ì¤‘ë³µ ì—¬ë¶€ë¥¼ ë¯¸ë¦¬ í™•ì¸í•˜ëŠ” ê²ƒì´ ì¢‹ìŠµë‹ˆë‹¤. ì˜ˆë¥¼ ë“¤ì–´, ì‚¬ìš©ìê°€ ì‚¬ìš©ì ì´ë¦„ì„ ì…ë ¥í•  ë•Œë‚˜ ì…ë ¥ í•„ë“œê°€ í¬ì»¤ìŠ¤ë¥¼ ìƒì„ ë•Œ ì¤‘ë³µ ì—¬ë¶€ë¥¼ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ë ‡ê²Œ í•˜ë©´ ë¶ˆí•„ìš”í•œ ì–‘ì‹ ì œì¶œì„ ë°©ì§€í•˜ê³  ì‚¬ìš©ìì—ê²Œ ì¦‰ê°ì ì¸ í”¼ë“œë°±ì„ ì œê³µí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ëŸ¬í•œ í™•ì¸ ìš”ì²­ì˜ ë¹ˆë„ë¥¼ ê´€ë¦¬í•˜ê¸° ìœ„í•´ [use-debounce](https://www.npmjs.com/package/use-debounce)ì™€ ê°™ì€ ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

</AppOnly>

<PagesOnly>

Here are the steps to implement a sign-up and/or login form:

1. The user submits their credentials through a form.
2. The form sends a request that is handled by an API route.
3. Upon successful verification, the process is completed, indicating the user's successful authentication.
4. If verification is unsuccessful, an error message is shown.

Consider a login form where users can input their credentials:

íšŒì›ê°€ì… ë˜ëŠ” ë¡œê·¸ì¸ ì–‘ì‹ì„ êµ¬í˜„í•˜ëŠ” ë‹¨ê³„ëŠ” ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤:

1. ì‚¬ìš©ìê°€ ì–‘ì‹ì„ í†µí•´ ìê²© ì¦ëª…ì„ ì œì¶œí•©ë‹ˆë‹¤.
2. ì–‘ì‹ì´ API ê²½ë¡œì—ì„œ ì²˜ë¦¬ë˜ëŠ” ìš”ì²­ì„ ë³´ëƒ…ë‹ˆë‹¤.
3. ê²€ì¦ì´ ì„±ê³µí•˜ë©´ ì‚¬ìš©ìê°€ ì„±ê³µì ìœ¼ë¡œ ì¸ì¦ë˜ì—ˆìŒì„ ë‚˜íƒ€ëƒ…ë‹ˆë‹¤.
4. ê²€ì¦ì´ ì‹¤íŒ¨í•˜ë©´ ì˜¤ë¥˜ ë©”ì‹œì§€ê°€ í‘œì‹œë©ë‹ˆë‹¤.

ì‚¬ìš©ìê°€ ìê²© ì¦ëª…ì„ ì…ë ¥í•  ìˆ˜ ìˆëŠ” ë¡œê·¸ì¸ ì–‘ì‹ì„ ê³ ë ¤í•´ë³´ì„¸ìš”:

```tsx filename="pages/login.tsx" switcher
import { FormEvent } from "react";
import { useRouter } from "next/router";

export default function LoginPage() {
  const router = useRouter();

  async function handleSubmit(event: FormEvent<HTMLFormElement>) {
    event.preventDefault();

    const formData = new FormData(event.currentTarget);
    const email = formData.get("email");
    const password = formData.get("password");

    const response = await fetch("/api/auth/login", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ email, password }),
    });

    if (response.ok) {
      router.push("/profile");
    } else {
      // Handle errors
    }
  }

  return (
    <form onSubmit={handleSubmit}>
      <input type="email" name="email" placeholder="Email" required />
      <input type="password" name="password" placeholder="Password" required />
      <button type="submit">Login</button>
    </form>
  );
}
```

```jsx filename="pages/login.jsx" switcher
import { FormEvent } from "react";
import { useRouter } from "next/router";

export default function LoginPage() {
  const router = useRouter();

  async function handleSubmit(event) {
    event.preventDefault();

    const formData = new FormData(event.currentTarget);
    const email = formData.get("email");
    const password = formData.get("password");

    const response = await fetch("/api/auth/login", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ email, password }),
    });

    if (response.ok) {
      router.push("/profile");
    } else {
      // Handle errors
    }
  }

  return (
    <form onSubmit={handleSubmit}>
      <input type="email" name="email" placeholder="Email" required />
      <input type="password" name="password" placeholder="Password" required />
      <button type="submit">Login</button>
    </form>
  );
}
```

ìœ„ ì–‘ì‹ì—ëŠ” ì‚¬ìš©ìì˜ ì´ë©”ì¼ê³¼ ë¹„ë°€ë²ˆí˜¸ë¥¼ ìº¡ì²˜í•˜ê¸° ìœ„í•œ ë‘ ê°œì˜ ì…ë ¥ í•„ë“œê°€ ìˆìŠµë‹ˆë‹¤. ì œì¶œ ì‹œ, API ê²½ë¡œ (`/api/auth/login`)ë¡œ POST ìš”ì²­ì„ ë³´ë‚´ëŠ” í•¨ìˆ˜ê°€ íŠ¸ë¦¬ê±°ë©ë‹ˆë‹¤.

ê·¸ëŸ° ë‹¤ìŒ API ê²½ë¡œì—ì„œ ì¸ì¦ì„ ì²˜ë¦¬í•˜ê¸° ìœ„í•´ ì¸ì¦ ì œê³µìì˜ APIë¥¼ í˜¸ì¶œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:

```ts filename="pages/api/auth/login.ts" switcher
import type { NextApiRequest, NextApiResponse } from "next";
import { signIn } from "@/auth";

export default async function handler(
  req: NextApiRequest,
  res: NextApiResponse
) {
  try {
    const { email, password } = req.body;
    await signIn("credentials", { email, password });

    res.status(200).json({ success: true });
  } catch (error) {
    if (error.type === "CredentialsSignin") {
      res.status(401).json({ error: "Invalid credentials." });
    } else {
      res.status(500).json({ error: "Something went wrong." });
    }
  }
}
```

```js filename="pages/api/auth/login.js" switcher
import { signIn } from "@/auth";

export default async function handler(req, res) {
  try {
    const { email, password } = req.body;
    await signIn("credentials", { email, password });

    res.status(200).json({ success: true });
  } catch (error) {
    if (error.type === "CredentialsSignin") {
      res.status(401).json({ error: "Invalid credentials." });
    } else {
      res.status(500).json({ error: "Something went wrong." });
    }
  }
}
```

</PagesOnly>

## Session Management

ì„¸ì…˜ ê´€ë¦¬ëŠ” ì‚¬ìš©ìì˜ ì¸ì¦ ìƒíƒœë¥¼ ìš”ì²­ ê°„ì— ìœ ì§€í•˜ë„ë¡ í•©ë‹ˆë‹¤. ì´ëŠ” ì„¸ì…˜ ë˜ëŠ” í† í°ì„ ìƒì„±, ì €ì¥, ê°±ì‹  ë° ì‚­ì œí•˜ëŠ” ì‘ì—…ì„ í¬í•¨í•©ë‹ˆë‹¤.

ì„¸ì…˜ì—ëŠ” ë‘ ê°€ì§€ ìœ í˜•ì´ ìˆìŠµë‹ˆë‹¤:

1. [**ë¬´ìƒíƒœ(Stateless)**](#stateless-sessions): ì„¸ì…˜ ë°ì´í„°(ë˜ëŠ” í† í°)ê°€ ë¸Œë¼ìš°ì €ì˜ ì¿ í‚¤ì— ì €ì¥ë©ë‹ˆë‹¤. ì¿ í‚¤ëŠ” ê° ìš”ì²­ê³¼ í•¨ê»˜ ì „ì†¡ë˜ì–´ ì„œë²„ì—ì„œ ì„¸ì…˜ì„ ê²€ì¦í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ ë°©ë²•ì€ ë” ê°„ë‹¨í•˜ì§€ë§Œ, ì œëŒ€ë¡œ êµ¬í˜„ë˜ì§€ ì•Šìœ¼ë©´ ë³´ì•ˆì´ ë–¨ì–´ì§ˆ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
2. [**ë°ì´í„°ë² ì´ìŠ¤ ê¸°ë°˜(Database)**](#database-sessions): ì„¸ì…˜ ë°ì´í„°ê°€ ë°ì´í„°ë² ì´ìŠ¤ì— ì €ì¥ë˜ë©°, ì‚¬ìš©ìì˜ ë¸Œë¼ìš°ì €ì—ëŠ” ì•”í˜¸í™”ëœ ì„¸ì…˜ IDë§Œ ì „ë‹¬ë©ë‹ˆë‹¤. ì´ ë°©ë²•ì€ ë” ì•ˆì „í•˜ì§€ë§Œ, êµ¬í˜„ì´ ë³µì¡í•˜ê³  ë” ë§ì€ ì„œë²„ ìì›ì„ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

> **ì°¸ê³ :** ì–´ëŠ ë°©ë²•ì´ë“  ì‚¬ìš©í•  ìˆ˜ ìˆì§€ë§Œ, [iron-session](https://github.com/vvo/iron-session) ë˜ëŠ” [Jose](https://github.com/panva/jose)ì™€ ê°™ì€ ì„¸ì…˜ ê´€ë¦¬ ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ì‚¬ìš©í•˜ëŠ” ê²ƒì„ ê¶Œì¥í•©ë‹ˆë‹¤.

### Stateless Sessions

<AppOnly>

ë¬´ìƒíƒœ ì„¸ì…˜ì„ ìƒì„±í•˜ê³  ê´€ë¦¬í•˜ë ¤ë©´ ëª‡ ê°€ì§€ ë‹¨ê³„ë¥¼ ë”°ë¼ì•¼ í•©ë‹ˆë‹¤:

1. ì„¸ì…˜ì„ ì„œëª…í•  ë¹„ë°€ í‚¤ë¥¼ ìƒì„±í•˜ê³  ì´ë¥¼ [í™˜ê²½ ë³€ìˆ˜](/docs/app/building-your-application/configuring/environment-variables)ë¡œ ì €ì¥í•©ë‹ˆë‹¤.
2. ì„¸ì…˜ ë°ì´í„°ë¥¼ ì•”í˜¸í™”/ë³µí˜¸í™”í•˜ëŠ” ë¡œì§ì„ ì‘ì„±í•©ë‹ˆë‹¤.
3. Next.js [`cookies()`](/docs/app/api-reference/functions/cookies) APIë¥¼ ì‚¬ìš©í•˜ì—¬ ì¿ í‚¤ë¥¼ ê´€ë¦¬í•©ë‹ˆë‹¤.

ìœ„ì˜ ë‹¨ê³„ ì™¸ì—ë„ ì‚¬ìš©ìê°€ ì• í”Œë¦¬ì¼€ì´ì…˜ìœ¼ë¡œ ëŒì•„ì˜¬ ë•Œ ì„¸ì…˜ì„ [ì—…ë°ì´íŠ¸(ë˜ëŠ” ê°±ì‹ )](#updating-or-refreshing-sessions)í•˜ê³ , ì‚¬ìš©ìê°€ ë¡œê·¸ì•„ì›ƒí•  ë•Œ ì„¸ì…˜ì„ [ì‚­ì œ](#deleting-the-session)í•˜ëŠ” ê¸°ëŠ¥ì„ ì¶”ê°€í•˜ëŠ” ê²ƒì„ ê³ ë ¤í•´ë³´ì„¸ìš”.

> **ì°¸ê³ :** [ì¸ì¦ ë¼ì´ë¸ŒëŸ¬ë¦¬](#auth-libraries)ê°€ ì„¸ì…˜ ê´€ë¦¬ë¥¼ í¬í•¨í•˜ëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”.

#### 1. ë¹„ë°€ í‚¤ ìƒì„±

ì„¸ì…˜ì„ ì„œëª…í•  ë¹„ë°€ í‚¤ë¥¼ ìƒì„±í•˜ëŠ” ë°©ë²•ì—ëŠ” ì—¬ëŸ¬ ê°€ì§€ê°€ ìˆìŠµë‹ˆë‹¤. ì˜ˆë¥¼ ë“¤ì–´, í„°ë¯¸ë„ì—ì„œ `openssl` ëª…ë ¹ì„ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:

```bash filename="terminal"
openssl rand -base64 32
```

ì´ ëª…ë ¹ì€ ì„¸ì…˜ í‚¤ë¡œ ì‚¬ìš©í•  ìˆ˜ ìˆëŠ” 32ìë¦¬ì˜ ëœë¤ ë¬¸ìì—´ì„ ìƒì„±í•˜ì—¬ [í™˜ê²½ ë³€ìˆ˜ íŒŒì¼](/docs/app/building-your-application/configuring/environment-variables)ì— ì €ì¥í•©ë‹ˆë‹¤:

```bash filename=".env"
SESSION_SECRET=your_secret_key
```

ê·¸ëŸ° ë‹¤ìŒ ì„¸ì…˜ ê´€ë¦¬ ë¡œì§ì—ì„œ ì´ í‚¤ë¥¼ ì°¸ì¡°í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:

```js filename="app/lib/session.js"
const secretKey = process.env.SESSION_SECRET;
```

#### 2. ì„¸ì…˜ ì•”í˜¸í™” ë° ë³µí˜¸í™”

ë‹¤ìŒìœ¼ë¡œ, ì„ í˜¸í•˜ëŠ” [ì„¸ì…˜ ê´€ë¦¬ ë¼ì´ë¸ŒëŸ¬ë¦¬](#session-management-libraries)ë¥¼ ì‚¬ìš©í•˜ì—¬ ì„¸ì…˜ì„ ì•”í˜¸í™”í•˜ê³  ë³µí˜¸í™”í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ì „ ì˜ˆì œì—ì„œ ê³„ì†í•˜ì—¬ [Jose](https://www.npmjs.com/package/jose) (ë° Reactì˜ [`server-only`](https://www.npmjs.com/package/server-only) íŒ¨í‚¤ì§€)ë¥¼ ì‚¬ìš©í•˜ì—¬ ì„¸ì…˜ ê´€ë¦¬ ë¡œì§ì´ ì„œë²„ì—ì„œë§Œ ì‹¤í–‰ë˜ë„ë¡ ë³´ì¥í•©ë‹ˆë‹¤.

```tsx filename="app/lib/session.ts" switcher
import "server-only";
import { SignJWT, jwtVerify } from "jose";
import { SessionPayload } from "@/app/lib/definitions";

const secretKey = process.env.SESSION_SECRET;
const encodedKey = new TextEncoder().encode(secretKey);

export async function encrypt(payload: SessionPayload) {
  return new SignJWT(payload)
    .setProtectedHeader({ alg: "HS256" })
    .setIssuedAt()
    .setExpirationTime("7d")
    .sign(encodedKey);
}

export async function decrypt(session: string | undefined = "") {
  try {
    const { payload } = await jwtVerify(session, encodedKey, {
      algorithms: ["HS256"],
    });
    return payload;
  } catch (error) {
    console.log("Failed to verify session");
  }
}
```

```jsx filename="app/lib/session.js" switcher
import "server-only";
import { SignJWT, jwtVerify } from "jose";

const secretKey = process.env.SESSION_SECRET;
const encodedKey = new TextEncoder().encode(secretKey);

export async function encrypt(payload) {
  return new SignJWT(payload)
    .setProtectedHeader({ alg: "HS256" })
    .setIssuedAt()
    .setExpirationTime("7d")
    .sign(encodedKey);
}

export async function decrypt(session) {
  try {
    const { payload } = await jwtVerify(session, encodedKey, {
      algorithms: ["HS256"],
    });
    return payload;
  } catch (error) {
    console.log("Failed to verify session");
  }
}
```

> **íŒ**:
>
> - í˜ì´ë¡œë“œì—ëŠ” í›„ì† ìš”ì²­ì—ì„œ ì‚¬ìš©í•  ìµœì†Œí•œì˜ ê³ ìœ  ì‚¬ìš©ì ë°ì´í„°(ì˜ˆ: ì‚¬ìš©ì ID, ì—­í•  ë“±)ë§Œ í¬í•¨ë˜ì–´ì•¼ í•©ë‹ˆë‹¤. ì „í™”ë²ˆí˜¸, ì´ë©”ì¼ ì£¼ì†Œ, ì‹ ìš©ì¹´ë“œ ì •ë³´ì™€ ê°™ì€ ê°œì¸ ì‹ë³„ ê°€ëŠ¥ ì •ë³´ ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ì™€ ê°™ì€ ë¯¼ê°í•œ ë°ì´í„°ëŠ” í¬í•¨í•´ì„œëŠ” ì•ˆ ë©ë‹ˆë‹¤.

#### 3. ì¿ í‚¤ ì„¤ì •(ê¶Œì¥ ì˜µì…˜)

ì„¸ì…˜ì„ ì¿ í‚¤ì— ì €ì¥í•˜ë ¤ë©´ Next.js [`cookies()`](/docs/app/api-reference/functions/cookies) APIë¥¼ ì‚¬ìš©í•˜ì„¸ìš”. ì¿ í‚¤ëŠ” ì„œë²„ì—ì„œ ì„¤ì •ë˜ì–´ì•¼ í•˜ë©°, ë‹¤ìŒ ê¶Œì¥ ì˜µì…˜ì„ í¬í•¨í•´ì•¼ í•©ë‹ˆë‹¤:

- **HttpOnly**: í´ë¼ì´ì–¸íŠ¸ ì¸¡ JavaScriptê°€ ì¿ í‚¤ì— ì ‘ê·¼í•˜ì§€ ëª»í•˜ë„ë¡ ë°©ì§€í•©ë‹ˆë‹¤.
- **Secure**: httpsë¥¼ ì‚¬ìš©í•˜ì—¬ ì¿ í‚¤ë¥¼ ì „ì†¡í•©ë‹ˆë‹¤.
- **SameSite**: ì¿ í‚¤ê°€ í¬ë¡œìŠ¤ ì‚¬ì´íŠ¸ ìš”ì²­ê³¼ í•¨ê»˜ ì „ì†¡ë  ìˆ˜ ìˆëŠ”ì§€ ì—¬ë¶€ë¥¼ ì§€ì •í•©ë‹ˆë‹¤.
- **Max-Age ë˜ëŠ” Expires**: ì¼ì • ê¸°ê°„ í›„ì— ì¿ í‚¤ë¥¼ ì‚­ì œí•©ë‹ˆë‹¤.
- **Path**: ì¿ í‚¤ì˜ URL ê²½ë¡œë¥¼ ì •ì˜í•©ë‹ˆë‹¤.

ê° ì˜µì…˜ì— ëŒ€í•œ ìì„¸í•œ ë‚´ìš©ì€ [MDN](https://developer.mozilla.org/en-US/docs/Web/HTTP/Cookies)ì„ ì°¸ì¡°í•˜ì„¸ìš”.

```ts filename="app/lib/session.ts" switcher
import "server-only";
import { cookies } from "next/headers";

export async function createSession(userId: string) {
  const expiresAt = new Date(Date.now() + 7 * 24 * 60 * 60 * 1000);
  const session = await encrypt({ userId, expiresAt });

  cookies().set("session", session, {
    httpOnly: true,
    secure: true,
    expires: expiresAt,
    sameSite: "lax",
    path: "/",
  });
}
```

```js filename="app/lib/session.js" switcher
import "server-only";
import { cookies } from "next/headers";

export async function createSession(userId) {
  const expiresAt = new Date(Date.now() + 7 * 24 * 60 * 60 * 1000);
  const session = await encrypt({ userId, expiresAt });

  cookies().set("session", session, {
    httpOnly: true,
    secure: true,
    expires: expiresAt,
    sameSite: "lax",
    path: "/",
  });
}
```

ì„œë²„ ì•¡ì…˜ì—ì„œ `createSession()` í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•˜ê³ , [`redirect()`](/docs/app/building-your-application/routing/redirecting) APIë¥¼ ì‚¬ìš©í•˜ì—¬ ì‚¬ìš©ìë¥¼ ì ì ˆí•œ í˜ì´ì§€ë¡œ ë¦¬ë””ë ‰ì…˜í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:

```ts filename="app/actions/auth.ts" switcher
import { createSession } from "@/app/lib/session";

export async function signup(state: FormState, formData: FormData) {
  // Previous steps:
  // 1. Validate form fields
  // 2. Prepare data for insertion into database
  // 3. Insert the user into the database or call an Library API

  // Current steps:
  // 4. Create user session
  await createSession(user.id);
  // 5. Redirect user
  redirect("/profile");
}
```

```js filename="app/actions/auth.js" switcher
import { createSession } from "@/app/lib/session";

export async function signup(state, formData) {
  // Previous steps:
  // 1. Validate form fields
  // 2. Prepare data for insertion into database
  // 3. Insert the user into the database or call an Library API

  // Current steps:
  // 4. Create user session
  await createSession(user.id);
  // 5. Redirect user
  redirect("/profile");
}
```

> **íŒ**:
>
> - **ì¿ í‚¤ëŠ” ì„œë²„ì—ì„œ ì„¤ì •ë˜ì–´ì•¼ í•©ë‹ˆë‹¤**. ì´ë¥¼ í†µí•´ í´ë¼ì´ì–¸íŠ¸ ì¸¡ì˜ ë³€ì¡°ë¥¼ ë°©ì§€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
> - ğŸ¥ ìì„¸í•œ ë‚´ìš©ì€ Next.jsë¥¼ ì‚¬ìš©í•œ ë¬´ìƒíƒœ ì„¸ì…˜ ë° ì¸ì¦ì— ëŒ€í•´ ì•Œì•„ë³´ì„¸ìš” â†’ [YouTube (11ë¶„)](https://www.youtube.com/watch?v=DJvM2lSPn6w).

#### Updating (or refreshing) sessions

ì„¸ì…˜ì˜ ë§Œë£Œ ì‹œê°„ì„ ì—°ì¥í•  ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤. ì´ëŠ” ì‚¬ìš©ìê°€ ì• í”Œë¦¬ì¼€ì´ì…˜ì— ë‹¤ì‹œ ì ‘ì†í–ˆì„ ë•Œ ë¡œê·¸ì¸ì„ ìœ ì§€í•˜ëŠ” ë° ìœ ìš©í•©ë‹ˆë‹¤. ì˜ˆë¥¼ ë“¤ì–´:

```ts filename="app/lib/session.ts" switcher
import "server-only";
import { cookies } from "next/headers";
import { decrypt } from "@/app/lib/session";

export async function updateSession() {
  const session = cookies().get("session")?.value;
  const payload = await decrypt(session);

  if (!session || !payload) {
    return null;
  }

  const expires = new Date(Date.now() + 7 * 24 * 60 * 60 * 1000);
  cookies().set("session", session, {
    httpOnly: true,
    secure: true,
    expires: expires,
    sameSite: "lax",
    path: "/",
  });
}
```

```js filename="app/lib/session.js" switcher
import "server-only";
import { cookies } from "next/headers";
import { decrypt } from "@/app/lib/session";

export async function updateSession() {
  const session = cookies().get("session").value;
  const payload = await decrypt(session);

  if (!session || !payload) {
    return null;
  }

  const expires = new Date(Date.now() + 7 * 24 * 60 * 60 * 1000);
  cookies().set("session", session, {
    httpOnly: true,
    secure: true,
    expires: expires,
    sameSite: "lax",
    path: "/",
  });
}
```

> **íŒ:** ì¸ì¦ ë¼ì´ë¸ŒëŸ¬ë¦¬ê°€ ë¦¬í”„ë ˆì‹œ í† í°ì„ ì§€ì›í•˜ëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”. ì´ëŠ” ì‚¬ìš©ìì˜ ì„¸ì…˜ì„ ì—°ì¥í•˜ëŠ” ë° ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

#### Deleting the session

ì„¸ì…˜ì„ ì‚­ì œí•˜ë ¤ë©´ ì¿ í‚¤ë¥¼ ì‚­ì œí•˜ë©´ ë©ë‹ˆë‹¤:

```ts filename="app/lib/session.ts" switcher
import "server-only";
import { cookies } from "next/headers";

export function deleteSession() {
  cookies().delete("session");
}
```

```js filename="app/lib/session.js" switcher
import "server-only";
import { cookies } from "next/headers";

export function deleteSession() {
  cookies().delete("session");
}
```

ê·¸ëŸ° ë‹¤ìŒ ì• í”Œë¦¬ì¼€ì´ì…˜ì—ì„œ ë¡œê·¸ì•„ì›ƒí•  ë•Œ `deleteSession()` í•¨ìˆ˜ë¥¼ ì¬ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:

```ts filename="app/actions/auth.ts" switcher
import { cookies } from "next/headers";
import { deleteSession } from "@/app/lib/session";

export async function logout() {
  deleteSession();
  redirect("/login");
}
```

```js filename="app/actions/auth.js" switcher
import { cookies } from "next/headers";
import { deleteSession } from "@/app/lib/session";

export async function logout() {
  deleteSession();
  redirect("/login");
}
```

</AppOnly>

<PagesOnly>

#### Setting and deleting cookies

[API Routes](/docs/pages/building-your-application/routing/api-routes)ë¥¼ ì‚¬ìš©í•˜ì—¬ ì„œë²„ì—ì„œ ì„¸ì…˜ì„ ì¿ í‚¤ë¡œ ì„¤ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:

```ts filename="pages/api/login.ts" switcher
import { serialize } from "cookie";
import type { NextApiRequest, NextApiResponse } from "next";
import { encrypt } from "@/app/lib/session";

export default function handler(req: NextApiRequest, res: NextApiResponse) {
  const sessionData = req.body;
  const encryptedSessionData = encrypt(sessionData);

  const cookie = serialize("session", encryptedSessionData, {
    httpOnly: true,
    secure: process.env.NODE_ENV === "production",
    maxAge: 60 * 60 * 24 * 7, // ì¼ì£¼ì¼
    path: "/",
  });
  res.setHeader("Set-Cookie", cookie);
  res.status(200).json({ message: "Successfully set cookie!" });
}
```

```js filename="pages/api/login.js" switcher
import { serialize } from "cookie";
import { encrypt } from "@/app/lib/session";

export default function handler(req, res) {
  const sessionData = req.body;
  const encryptedSessionData = encrypt(sessionData);

  const cookie = serialize("session", encryptedSessionData, {
    httpOnly: true,
    secure: process.env.NODE_ENV === "production",
    maxAge: 60 * 60 * 24 * 7, // ì¼ì£¼ì¼
    path: "/",
  });
  res.setHeader("Set-Cookie", cookie);
  res.status(200).json({ message: "Successfully set cookie!" });
}
```

</PagesOnly>

### Database Sessions

ë°ì´í„°ë² ì´ìŠ¤ ì„¸ì…˜ì„ ìƒì„±í•˜ê³  ê´€ë¦¬í•˜ë ¤ë©´ ë‹¤ìŒ ë‹¨ê³„ë¥¼ ë”°ë¼ì•¼ í•©ë‹ˆë‹¤:

1. ì„¸ì…˜ê³¼ ë°ì´í„°ë¥¼ ì €ì¥í•  í…Œì´ë¸”ì„ ë°ì´í„°ë² ì´ìŠ¤ì— ìƒì„±í•˜ê±°ë‚˜ ì¸ì¦ ë¼ì´ë¸ŒëŸ¬ë¦¬ê°€ ì´ ì‘ì—…ì„ ì²˜ë¦¬í•˜ëŠ”ì§€ í™•ì¸í•©ë‹ˆë‹¤.
2. ì„¸ì…˜ì„ ì‚½ì…, ì—…ë°ì´íŠ¸ ë° ì‚­ì œí•˜ëŠ” ê¸°ëŠ¥ì„ êµ¬í˜„í•©ë‹ˆë‹¤.
3. ì„¸ì…˜ IDë¥¼ ì‚¬ìš©ìì˜ ë¸Œë¼ìš°ì €ì— ì €ì¥í•˜ê¸° ì „ì— ì•”í˜¸í™”í•˜ê³ , ë°ì´í„°ë² ì´ìŠ¤ì™€ ì¿ í‚¤ê°€ ë™ê¸°í™”ë˜ë„ë¡ í•©ë‹ˆë‹¤(ì´ ë‹¨ê³„ëŠ” ì„ íƒ ì‚¬í•­ì´ì§€ë§Œ, [ë¯¸ë“¤ì›¨ì–´](#optimistic-checks-with-middleware-optional)ì—ì„œ ë‚™ê´€ì  ì¸ì¦ ê²€ì‚¬ë¥¼ ìœ„í•´ ê¶Œì¥ë©ë‹ˆë‹¤).

<AppOnly>

ì˜ˆë¥¼ ë“¤ì–´:

```ts filename="app/lib/session.ts" switcher
import cookies from "next/headers";
import { db } from "@/app/lib/db";
import { encrypt } from "@/app/lib/session";

export async function createSession(id: number) {
  const expiresAt = new Date(Date.now() + 7 * 24 * 60 * 60 * 1000);

  // 1. ë°ì´í„°ë² ì´ìŠ¤ì— ì„¸ì…˜ ìƒì„±
  const data = await db
    .insert(sessions)
    .values({
      userId: id,
      expiresAt,
    })
    // ì„¸ì…˜ ID ë°˜í™˜
    .returning({ id: sessions.id });

  const sessionId = data[0].id;

  // 2. ì„¸ì…˜ ID ì•”í˜¸í™”
  const session = await encrypt({ sessionId, expiresAt });

  // 3. ë‚™ê´€ì  ì¸ì¦ ê²€ì‚¬ë¥¼ ìœ„í•´ ì„¸ì…˜ì„ ì¿ í‚¤ì— ì €ì¥
  cookies().set("session", session, {
    httpOnly: true,
    secure: true,
    expires: expiresAt,
    sameSite: "lax",
    path: "/",
  });
}
```

```js filename="app/lib/session.js" switcher
import cookies from "next/headers";
import { db } from "@/app/lib/db";
import { encrypt } from "@/app/lib/session";

export async function createSession(id) {
  const expiresAt = new Date(Date.now() + 7 * 24 * 60 * 60 * 1000);

  // 1. ë°ì´í„°ë² ì´ìŠ¤ì— ì„¸ì…˜ ìƒì„±
  const data = await db
    .insert(sessions)
    .values({
      userId: id,
      expiresAt,
    })
    // ì„¸ì…˜ ID ë°˜í™˜
    .returning({ id: sessions.id });

  const sessionId = data[0].id;

  // 2. ì„¸ì…˜ ID ì•”í˜¸í™”
  const session = await encrypt({ sessionId, expiresAt });

  // 3. ë‚™ê´€ì  ì¸ì¦ ê²€ì‚¬ë¥¼ ìœ„í•´ ì„¸ì…˜ì„ ì¿ í‚¤ì— ì €ì¥
  cookies().set("session", session, {
    httpOnly: true,
    secure: true,
    expires: expiresAt,
    sameSite: "lax",
    path: "/",
  });
}
```

> **íŒ**:
>
> - ë” ë¹ ë¥¸ ë°ì´í„° ê²€ìƒ‰ì„ ìœ„í•´ [Vercel Redis](https://vercel.com/docs/storage/vercel-kv)ì™€ ê°™ì€ ë°ì´í„°ë² ì´ìŠ¤ë¥¼ ì‚¬ìš©í•˜ëŠ” ê²ƒì„ ê³ ë ¤í•´ë³´ì„¸ìš”. ê·¸ëŸ¬ë‚˜ ì„¸ì…˜ ë°ì´í„°ë¥¼ ê¸°ë³¸ ë°ì´í„°ë² ì´ìŠ¤ì— ìœ ì§€í•˜ê³  ë°ì´í„° ìš”ì²­ì„ ê²°í•©í•˜ì—¬ ì¿¼ë¦¬ ìˆ˜ë¥¼ ì¤„ì¼ ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤.
> - ë°ì´í„°ë² ì´ìŠ¤ ì„¸ì…˜ì„ ì‚¬ìš©í•˜ì—¬ ì‚¬ìš©ìê°€ ë§ˆì§€ë§‰ìœ¼ë¡œ ë¡œê·¸ì¸í•œ ì‹œê°„, í™œì„± ì¥ì¹˜ ìˆ˜ë¥¼ ì¶”ì í•˜ê±°ë‚˜ ì‚¬ìš©ìê°€ ëª¨ë“  ì¥ì¹˜ì—ì„œ ë¡œê·¸ì•„ì›ƒí•  ìˆ˜ ìˆëŠ” ê¸°ëŠ¥ê³¼ ê°™ì€ ê³ ê¸‰ ì‚¬ìš© ì‚¬ë¡€ë¥¼ ì²˜ë¦¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ì„¸ì…˜ ê´€ë¦¬ë¥¼ êµ¬í˜„í•œ í›„ì—ëŠ” ì• í”Œë¦¬ì¼€ì´ì…˜ ë‚´ì—ì„œ ì‚¬ìš©ìê°€ ì ‘ê·¼í•˜ê³  ìˆ˜í–‰í•  ìˆ˜ ìˆëŠ” ì‘ì—…ì„ ì œì–´í•˜ê¸° ìœ„í•´ ê¶Œí•œ ë¶€ì—¬ ë¡œì§ì„ ì¶”ê°€í•´ì•¼ í•©ë‹ˆë‹¤. [Authorization](#authorization) ì„¹ì…˜ìœ¼ë¡œ ì´ë™í•˜ì—¬ ìì„¸íˆ ì•Œì•„ë³´ì„¸ìš”.

</AppOnly>

<PagesOnly>

**ì„œë²„ì—ì„œ ì„¸ì…˜ ìƒì„±**:

```ts filename="pages/api/create-session.ts" switcher
import db from "../../lib/db";
import type { NextApiRequest, NextApiResponse } from "next";

export default async function handler(
  req: NextApiRequest,
  res: NextApiResponse
) {
  try {
    const user = req.body;
    const sessionId = generateSessionId();
    await db.insertSession({
      sessionId,
      userId: user.id,
      createdAt: new Date(),
    });

    res.status(200).json({ sessionId });
  } catch (error) {
    res.status(500).json({ error: "Internal Server Error" });
  }
}
```

```js filename="pages/api/create-session.js" switcher
import db from "../../lib/db";

export default async function handler(req, res) {
  try {
    const user = req.body;
    const sessionId = generateSessionId();
    await db.insertSession({
      sessionId,
      userId: user.id,
      createdAt: new Date(),
    });

    res.status(200).json({ sessionId });
  } catch (error) {
    res.status(500).json({ error: "Internal Server Error" });
  }
}
```

</PagesOnly>

## Authorization

ì‚¬ìš©ìê°€ ì¸ì¦ë˜ê³  ì„¸ì…˜ì´ ìƒì„±ëœ í›„, ì• í”Œë¦¬ì¼€ì´ì…˜ ë‚´ì—ì„œ ì‚¬ìš©ìê°€ ì ‘ê·¼í•˜ê³  ìˆ˜í–‰í•  ìˆ˜ ìˆëŠ” ì‘ì—…ì„ ì œì–´í•˜ê¸° ìœ„í•´ ê¶Œí•œ ë¶€ì—¬ë¥¼ êµ¬í˜„í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ê¶Œí•œ ë¶€ì—¬ ê²€ì‚¬ëŠ” ë‘ ê°€ì§€ ì£¼ìš” ìœ í˜•ì´ ìˆìŠµë‹ˆë‹¤:

1. **Optimistic**: ì¿ í‚¤ì— ì €ì¥ëœ ì„¸ì…˜ ë°ì´í„°ë¥¼ ì‚¬ìš©í•˜ì—¬ ì‚¬ìš©ìê°€ ê²½ë¡œì— ì ‘ê·¼í•˜ê±°ë‚˜ ì‘ì—…ì„ ìˆ˜í–‰í•  ê¶Œí•œì´ ìˆëŠ”ì§€ í™•ì¸í•©ë‹ˆë‹¤. ì´ëŸ¬í•œ ê²€ì‚¬ëŠ” UI ìš”ì†Œë¥¼ í‘œì‹œ/ìˆ¨ê¸°ê±°ë‚˜ ê¶Œí•œ ë˜ëŠ” ì—­í• ì— ë”°ë¼ ì‚¬ìš©ìë¥¼ ë¦¬ë””ë ‰ì…˜í•˜ëŠ” ê²ƒê³¼ ê°™ì€ ë¹ ë¥¸ ì‘ì—…ì— ìœ ìš©í•©ë‹ˆë‹¤.
2. **Secure**: ë°ì´í„°ë² ì´ìŠ¤ì— ì €ì¥ëœ ì„¸ì…˜ ë°ì´í„°ë¥¼ ì‚¬ìš©í•˜ì—¬ ì‚¬ìš©ìê°€ ê²½ë¡œì— ì ‘ê·¼í•˜ê±°ë‚˜ ì‘ì—…ì„ ìˆ˜í–‰í•  ê¶Œí•œì´ ìˆëŠ”ì§€ í™•ì¸í•©ë‹ˆë‹¤. ì´ëŸ¬í•œ ê²€ì‚¬ëŠ” ë” ì•ˆì „í•˜ë©° ë¯¼ê°í•œ ë°ì´í„°ì— ì ‘ê·¼í•˜ê±°ë‚˜ ì‘ì—…ì„ ìˆ˜í–‰í•´ì•¼ í•˜ëŠ” ê²½ìš°ì— ì‚¬ìš©ë©ë‹ˆë‹¤.

ë‘ ê²½ìš° ëª¨ë‘ ë‹¤ìŒì„ ê¶Œì¥í•©ë‹ˆë‹¤:

- ê¶Œí•œ ë¶€ì—¬ ë¡œì§ì„ ì¤‘ì•™ ì§‘ì¤‘í™”í•˜ê¸° ìœ„í•´ [ë°ì´í„° ì ‘ê·¼ ë ˆì´ì–´(DAL)](#creating-a-data-access-layer-dal) ìƒì„±
- í•„ìš”í•œ ë°ì´í„°ë§Œ ë°˜í™˜í•˜ê¸° ìœ„í•´ [ë°ì´í„° ì „ì†¡ ê°ì²´(DTO)](#using-data-transfer-objects-dto) ì‚¬ìš©
- ë‚™ê´€ì  ê²€ì‚¬ë¥¼ ìˆ˜í–‰í•˜ê¸° ìœ„í•´ [ë¯¸ë“¤ì›¨ì–´](#optimistic-checks-with-middleware-optional)ë¥¼ ì„ íƒì ìœ¼ë¡œ ì‚¬ìš©

### ë‚™ê´€ì  ê²€ì‚¬ì™€ ë¯¸ë“¤ì›¨ì–´ (ì„ íƒ ì‚¬í•­)

ì¼ë¶€ ê²½ìš°ì—ëŠ” [ë¯¸ë“¤ì›¨ì–´](/docs/app/building-your-application/routing/middleware)ë¥¼ ì‚¬ìš©í•˜ì—¬ ê¶Œí•œì— ë”°ë¼ ì‚¬ìš©ìë¥¼ ë¦¬ë””ë ‰ì…˜í•˜ëŠ” ê²ƒì´ ìœ ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:

- ë‚™ê´€ì  ê²€ì‚¬ë¥¼ ìˆ˜í–‰í•˜ê¸° ìœ„í•´. ë¯¸ë“¤ì›¨ì–´ëŠ” ëª¨ë“  ê²½ë¡œì—ì„œ ì‹¤í–‰ë˜ë¯€ë¡œ ë¦¬ë””ë ‰ì…˜ ë¡œì§ì„ ì¤‘ì•™ ì§‘ì¤‘í™”í•˜ê³  ê¶Œí•œì´ ì—†ëŠ” ì‚¬ìš©ìë¥¼ ë¯¸ë¦¬ í•„í„°ë§í•˜ëŠ” ì¢‹ì€ ë°©ë²•ì…ë‹ˆë‹¤.
- ì‚¬ìš©ì ê°„ì— ë°ì´í„°ë¥¼ ê³µìœ í•˜ëŠ” ì •ì  ê²½ë¡œë¥¼ ë³´í˜¸í•˜ê¸° ìœ„í•´ (ì˜ˆ: ìœ ë£Œ ì½˜í…ì¸ ).

ê·¸ëŸ¬ë‚˜ ë¯¸ë“¤ì›¨ì–´ëŠ” ëª¨ë“  ê²½ë¡œ, íŠ¹íˆ [ë¯¸ë¦¬ ë¡œë“œëœ](/docs/app/building-your-application/routing/linking-and-navigating#2-prefetching) ê²½ë¡œì—ì„œë„ ì‹¤í–‰ë˜ë¯€ë¡œ ì¿ í‚¤ì—ì„œ ì„¸ì…˜ì„ ì½ëŠ” ê²ƒ(ë‚™ê´€ì  ê²€ì‚¬)ì—ë§Œ ì§‘ì¤‘í•˜ê³  ë°ì´í„°ë² ì´ìŠ¤ ê²€ì‚¬ë¥¼ í”¼í•˜ì—¬ ì„±ëŠ¥ ë¬¸ì œë¥¼ ë°©ì§€í•´ì•¼ í•©ë‹ˆë‹¤.

ì˜ˆë¥¼ ë“¤ì–´:

```tsx filename="middleware.ts" switcher
import { NextRequest, NextResponse } from "next/server";
import { decrypt } from "@/app/lib/session";
import { cookies } from "next/headers";

// 1. ë³´í˜¸ëœ ê²½ë¡œì™€ ê³µê°œ ê²½ë¡œ ì§€ì •
const protectedRoutes = ["/dashboard"];
const publicRoutes = ["/login", "/signup", "/"];

export default async function middleware(req: NextRequest) {
  // 2. í˜„ì¬ ê²½ë¡œê°€ ë³´í˜¸ëœ ê²½ë¡œì¸ì§€ ê³µê°œ ê²½ë¡œì¸ì§€ í™•ì¸
  const path = req.nextUrl.pathname;
  const isProtectedRoute = protectedRoutes.includes(path);
  const isPublicRoute = publicRoutes.includes(path);

  // 3. ì¿ í‚¤ì—ì„œ ì„¸ì…˜ í•´ë…
  const cookie = cookies().get("session")?.value;
  const session = await decrypt(cookie);

  // 5. ì‚¬ìš©ìê°€ ì¸ì¦ë˜ì§€ ì•Šì€ ê²½ìš° /loginìœ¼ë¡œ ë¦¬ë””ë ‰ì…˜
  if (isProtectedRoute && !session?.userId) {
    return NextResponse.redirect(new URL("/login", req.nextUrl));
  }

  // 6. ì‚¬ìš©ìê°€ ì¸ì¦ëœ ê²½ìš° /dashboardë¡œ ë¦¬ë””ë ‰ì…˜
  if (
    isPublicRoute &&
    session?.userId &&
    !req.nextUrl.pathname.startsWith("/dashboard")
  ) {
    return NextResponse.redirect(new URL("/dashboard", req.nextUrl));
  }

  return NextResponse.next();
}

// ë¯¸ë“¤ì›¨ì–´ê°€ ì‹¤í–‰ë˜ì§€ ì•Šì•„ì•¼ í•˜ëŠ” ê²½ë¡œ
export const config = {
  matcher: ["/((?!api|_next/static|_next/image|.*\\.png$).*)"],
};
```

```js filename="middleware.js" switcher
import { NextResponse } from "next/server";
import { decrypt } from "@/app/lib/session";
import { cookies } from "next/headers";

// 1. ë³´í˜¸ëœ ê²½ë¡œì™€ ê³µê°œ ê²½ë¡œ ì§€ì •
const protectedRoutes = ["/dashboard"];
const publicRoutes = ["/login", "/signup", "/"];

export default async function middleware(req) {
  // 2. í˜„ì¬ ê²½ë¡œê°€ ë³´í˜¸ëœ ê²½ë¡œì¸ì§€ ê³µê°œ ê²½ë¡œì¸ì§€ í™•ì¸
  const path = req.nextUrl.pathname;
  const isProtectedRoute = protectedRoutes.includes(path);
  const isPublicRoute = publicRoutes.includes(path);

  // 3. ì¿ í‚¤ì—ì„œ ì„¸ì…˜ í•´ë…
  const cookie = cookies().get("session").value;
  const session = await decrypt(cookie);

  // 5. ì‚¬ìš©ìê°€ ì¸ì¦ë˜ì§€ ì•Šì€ ê²½ìš° /loginìœ¼ë¡œ ë¦¬ë””ë ‰ì…˜
  if (isProtectedRoute && !session?.userId) {
    return NextResponse.redirect(new URL("/login", req.nextUrl));
  }

  // 6. ì‚¬ìš©ìê°€ ì¸ì¦ëœ ê²½ìš° /dashboardë¡œ ë¦¬ë””ë ‰ì…˜
  if (
    isPublicRoute &&
    session?.userId &&
    !req.nextUrl.pathname.startsWith("/dashboard")
  ) {
    return NextResponse.redirect(new URL("/dashboard", req.nextUrl));
  }

  return NextResponse.next();
}

// ë¯¸ë“¤ì›¨ì–´ê°€ ì‹¤í–‰ë˜ì§€ ì•Šì•„ì•¼ í•˜ëŠ” ê²½ë¡œ
export const config = {
  matcher: ["/((?!api|_next/static|_next/image|.*\\.png$).*)"],
};
```

ë¯¸ë“¤ì›¨ì–´ëŠ” ì´ˆê¸° ê²€ì‚¬ì— ìœ ìš©í•  ìˆ˜ ìˆì§€ë§Œ, ë°ì´í„° ë³´í˜¸ì˜ ìœ ì¼í•œ ë°©ì–´ì„ ì´ ë˜ì–´ì„œëŠ” ì•ˆ ë©ë‹ˆë‹¤. ëŒ€ë¶€ë¶„ì˜ ë³´ì•ˆ ê²€ì‚¬ëŠ” ë°ì´í„° ì†ŒìŠ¤ì— ìµœëŒ€í•œ ê°€ê¹ê²Œ ìˆ˜í–‰ë˜ì–´ì•¼ í•©ë‹ˆë‹¤. ìì„¸í•œ ë‚´ìš©ì€ [ë°ì´í„° ì ‘ê·¼ ë ˆì´ì–´(DAL)](#creating-a-data-access-layer-dal)ì„ ì°¸ì¡°í•˜ì„¸ìš”.

> **íŒ**:
>
> - ë¯¸ë“¤ì›¨ì–´ì—ì„œ `req.cookies.get('session).value`ë¥¼ ì‚¬ìš©í•˜ì—¬ ì¿ í‚¤ë¥¼ ì½ì„ ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤.
> - ë¯¸ë“¤ì›¨ì–´ëŠ” [Edge Runtime](/docs/app/building-your-application/rendering/edge-and-nodejs-runtimes)ì„ ì‚¬ìš©í•˜ë¯€ë¡œ ì¸ì¦ ë¼ì´ë¸ŒëŸ¬ë¦¬ì™€ ì„¸ì…˜ ê´€ë¦¬ ë¼ì´ë¸ŒëŸ¬ë¦¬ê°€ í˜¸í™˜ë˜ëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”.
> - ë¯¸ë“¤ì›¨ì–´ì—ì„œ ì‹¤í–‰ë  ê²½ë¡œë¥¼ ì§€ì •í•˜ë ¤ë©´ `matcher` ì†ì„±ì„ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ê·¸ëŸ¬ë‚˜ ì¸ì¦ì„ ìœ„í•´ì„œëŠ” ë¯¸ë“¤ì›¨ì–´ê°€ ëª¨ë“  ê²½ë¡œì—ì„œ ì‹¤í–‰ë˜ë„ë¡ ê¶Œì¥ë©ë‹ˆë‹¤.

<AppOnly>

### ë°ì´í„° ì ‘ê·¼ ë ˆì´ì–´(DAL) ìƒì„±

ë°ì´í„° ìš”ì²­ê³¼ ê¶Œí•œ ë¶€ì—¬ ë¡œì§ì„ ì¤‘ì•™ ì§‘ì¤‘í™”í•˜ê¸° ìœ„í•´ DALì„ ìƒì„±í•˜ëŠ” ê²ƒì´ ì¢‹ìŠµë‹ˆë‹¤.

DALì—ëŠ” ì‚¬ìš©ìê°€ ì• í”Œë¦¬ì¼€ì´ì…˜ê³¼ ìƒí˜¸ì‘ìš©í•  ë•Œ ì„¸ì…˜ì„ í™•ì¸í•˜ëŠ” í•¨ìˆ˜ê°€ í¬í•¨ë˜ì–´ì•¼ í•©ë‹ˆë‹¤. ìµœì†Œí•œ, í•¨ìˆ˜ëŠ” ì„¸ì…˜ì´ ìœ íš¨í•œì§€ í™•ì¸í•œ ë‹¤ìŒ ë¦¬ë””ë ‰ì…˜í•˜ê±°ë‚˜ ì¶”ê°€ ìš”ì²­ì„ ìˆ˜í–‰í•˜ëŠ” ë° í•„ìš”í•œ ì‚¬ìš©ì ì •ë³´ë¥¼ ë°˜í™˜í•´ì•¼ í•©ë‹ˆë‹¤.

ì˜ˆë¥¼ ë“¤ì–´, Reactì˜ [cache](https://react.dev/reference/react/cache) APIë¥¼ ì‚¬ìš©í•˜ì—¬ React ë Œë”ë§ ë™ì•ˆ í•¨ìˆ˜ì˜ ë°˜í™˜ ê°’ì„ ë©”ëª¨ì´ì¦ˆí•˜ëŠ” `verifySession()` í•¨ìˆ˜ë¥¼ í¬í•¨í•˜ëŠ” ë³„ë„ì˜ íŒŒì¼ì„ ë§Œë“­ë‹ˆë‹¤:

```tsx filename="app/lib/dal.ts" switcher
import "server-only";

import { cookies } from "next/headers";
import { decrypt } from "@/app/lib/session";

export const verifySession = cache(async () => {
  const cookie = cookies().get("session")?.value;
  const session = await decrypt(cookie);

  if (!session?.userId) {
    redirect("/login");
  }

  return { isAuth: true, userId: session.userId };
});
```

```js filename="app/lib/dal.js" switcher
import "server-only";

import { cookies } from "next/headers";
import { decrypt } from "@/app/lib/session";

export const verifySession = cache(async () => {
  const cookie = cookies().get("session").value;
  const session = await decrypt(cookie);

  if (!session.userId) {
    redirect("/login");
  }

  return { isAuth: true, userId: session.userId };
});
```

ê·¸ëŸ° ë‹¤ìŒ `verifySession()` í•¨ìˆ˜ë¥¼ ë°ì´í„° ìš”ì²­, ì„œë²„ ì•¡ì…˜, ë¼ìš°íŠ¸ í•¸ë“¤ëŸ¬ì—ì„œ í˜¸ì¶œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:

```tsx filename="app/lib/dal.ts" switcher
export const getUser = cache(async () => {
  const session = await verifySession();
  if (!session) return null;

  try {
    const data = await db.query.users.findMany({
      where: eq(users.id, session.userId),
      // ì „ì²´ ì‚¬ìš©ì ê°ì²´ ëŒ€ì‹  í•„ìš”í•œ ì—´ë§Œ ëª…ì‹œì ìœ¼ë¡œ ë°˜í™˜
      columns: {
        id: true,
        name: true,
        email: true,
      },
    });

    const user = data[0];

    return user;
  } catch (error) {
    console.log("Failed to fetch user");
    return null;
  }
});
```

```jsx filename="app/lib/dal.js" switcher
export const getUser = cache(async () => {
  const session = await verifySession();
  if (!session) return null;

  try {
    const data = await db.query.users.findMany({
      where: eq(users.id, session.userId),
      // ì „ì²´ ì‚¬ìš©ì ê°ì²´ ëŒ€ì‹  í•„ìš”í•œ ì—´ë§Œ ëª…ì‹œì ìœ¼ë¡œ ë°˜í™˜
      columns: {
        id: true,
        name: true,
        email: true,
      },
    });

    const user = data[0];

    return user;
  } catch (error) {
    console.log("Failed to fetch user");
    return null;
  }
});
```

> **íŒ**:
>
> - DALì€ ìš”ì²­ ì‹œ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ëŠ” ê²ƒì„ ë³´í˜¸í•˜ëŠ” ë° ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ê·¸ëŸ¬ë‚˜ ì‚¬ìš©ìê°€ ë°ì´í„°ë¥¼ ê³µìœ í•˜ëŠ” ì •ì  ê²½ë¡œì˜ ê²½ìš° ë°ì´í„°ëŠ” ìš”ì²­ ì‹œê°€ ì•„ë‹Œ ë¹Œë“œ ì‹œ ê°€ì ¸ì˜µë‹ˆë‹¤. ì •ì  ê²½ë¡œë¥¼ ë³´í˜¸í•˜ë ¤ë©´ [ë¯¸ë“¤ì›¨ì–´](#optimistic-checks-with-middleware-optional)ë¥¼ ì‚¬ìš©í•˜ì„¸ìš”.
> - ë³´ì•ˆ ê²€ì‚¬ë¥¼ ìœ„í•´ ì„¸ì…˜ IDë¥¼ ë°ì´í„°ë² ì´ìŠ¤ì™€ ë¹„êµí•˜ì—¬ ì„¸ì…˜ì´ ìœ íš¨í•œì§€ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. Reactì˜ [cache](https://react.dev/reference/react/cache) í•¨ìˆ˜ë¥¼ ì‚¬ìš©í•˜ì—¬ ë Œë”ë§ íŒ¨ìŠ¤ ë™ì•ˆ ë¶ˆí•„ìš”í•œ ì¤‘ë³µ ìš”ì²­ì„ í”¼í•˜ì„¸ìš”.
> - ê´€ë ¨ëœ ë°ì´í„° ìš”ì²­ì„ JavaScript í´ë˜ìŠ¤ì— í†µí•©í•˜ê³  ëª¨ë“  ë©”ì„œë“œ ì „ì— `verifySession()`ì„ ì‹¤í–‰í•˜ë„ë¡ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

### Using Data Transfer Objects (DTO)

ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¬ ë•ŒëŠ” ì• í”Œë¦¬ì¼€ì´ì…˜ì—ì„œ ì‚¬ìš©í•  í•„ìš”í•œ ë°ì´í„°ë§Œ ë°˜í™˜í•˜ê³  ì „ì²´ ê°ì²´ë¥¼ ë°˜í™˜í•˜ì§€ ì•ŠëŠ” ê²ƒì´ ì¢‹ìŠµë‹ˆë‹¤. ì˜ˆë¥¼ ë“¤ì–´ ì‚¬ìš©ì ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¬ ë•Œ, ì‚¬ìš©ìì˜ IDì™€ ì´ë¦„ë§Œ ë°˜í™˜í•˜ê³  ì•”í˜¸, ì „í™”ë²ˆí˜¸ ë“± ì „ì²´ ì‚¬ìš©ì ê°ì²´ë¥¼ ë°˜í™˜í•˜ì§€ ì•Šì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ê·¸ëŸ¬ë‚˜ ë°˜í™˜ë˜ëŠ” ë°ì´í„° êµ¬ì¡°ë¥¼ ì œì–´í•  ìˆ˜ ì—†ê±°ë‚˜ ì „ì²´ ê°ì²´ê°€ í´ë¼ì´ì–¸íŠ¸ë¡œ ì „ë‹¬ë˜ëŠ” ê²ƒì„ ë°©ì§€í•˜ê³ ì í•˜ëŠ” íŒ€ì—ì„œëŠ” ë…¸ì¶œí•  í•„ë“œë¥¼ ì§€ì •í•˜ëŠ” ë“±ì˜ ì „ëµì„ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

```tsx filename="app/lib/dto.ts" switcher
import "server-only";
import { getUser } from "@/app/lib/dal";

function canSeeUsername(viewer: User) {
  return true;
}

function canSeePhoneNumber(viewer: User, team: string) {
  return viewer.isAdmin || team === viewer.team;
}

export async function getProfileDTO(slug: string) {
  const data = await db.query.users.findMany({
    where: eq(users.slug, slug),
    // ì—¬ê¸°ì—ì„œ íŠ¹ì • ì—´ë§Œ ë°˜í™˜
  });
  const user = data[0];

  const currentUser = await getUser(user.id);

  // ë˜ëŠ” ì—¬ê¸°ì—ì„œ ì¿¼ë¦¬ì— íŠ¹ì •í•œ ê²ƒë§Œ ë°˜í™˜
  return {
    username: canSeeUsername(currentUser) ? user.username : null,
    phonenumber: canSeePhoneNumber(currentUser, user.team)
      ? user.phonenumber
      : null,
  };
}
```

```js filename="app/lib/dto.js" switcher
import "server-only";
import { getUser } from "@/app/lib/dal";

function canSeeUsername(viewer) {
  return true;
}

function canSeePhoneNumber(viewer, team) {
  return viewer.isAdmin || team === viewer.team;
}

export async function getProfileDTO(slug) {
  const data = await db.query.users.findMany({
    where: eq(users.slug, slug),
    // ì—¬ê¸°ì—ì„œ íŠ¹ì • ì—´ë§Œ ë°˜í™˜
  });
  const user = data[0];

  const currentUser = await getUser(user.id);

  // ë˜ëŠ” ì—¬ê¸°ì—ì„œ ì¿¼ë¦¬ì— íŠ¹ì •í•œ ê²ƒë§Œ ë°˜í™˜
  return {
    username: canSeeUsername(currentUser) ? user.username : null,
    phonenumber: canSeePhoneNumber(currentUser, user.team)
      ? user.phonenumber
      : null,
  };
}
```

ë°ì´í„° ìš”ì²­ê³¼ ê¶Œí•œ ë¶€ì—¬ ë¡œì§ì„ DALì— ì¤‘ì•™ ì§‘ì¤‘í™”í•˜ê³  DTOë¥¼ ì‚¬ìš©í•˜ë©´ ëª¨ë“  ë°ì´í„° ìš”ì²­ì´ ì•ˆì „í•˜ê³  ì¼ê´€ë˜ê²Œ ìœ ì§€ë˜ì–´ ì• í”Œë¦¬ì¼€ì´ì…˜ì´ í™•ì¥ë¨ì— ë”°ë¼ ìœ ì§€ ê´€ë¦¬, ê°ì‚¬ ë° ë””ë²„ê·¸ê°€ ìš©ì´í•´ì§‘ë‹ˆë‹¤.

> **ì•Œì•„ë‘ë©´ ì¢‹ì€ ì •ë³´**:
>
> - DTOë¥¼ ì •ì˜í•˜ëŠ” ë°©ë²•ì—ëŠ” ì—¬ëŸ¬ ê°€ì§€ê°€ ìˆìœ¼ë©°, `toJSON()`ì„ ì‚¬ìš©í•˜ëŠ” ë°©ë²•, ìœ„ì˜ ì˜ˆì œì™€ ê°™ì€ ê°œë³„ í•¨ìˆ˜ ë˜ëŠ” JS í´ë˜ìŠ¤ë¥¼ ì‚¬ìš©í•˜ëŠ” ë°©ë²• ë“±ì´ ìˆìŠµë‹ˆë‹¤. ì´ëŠ” JavaScript íŒ¨í„´ì´ë©° React ë˜ëŠ” Next.js ê¸°ëŠ¥ì´ ì•„ë‹ˆë¯€ë¡œ ì• í”Œë¦¬ì¼€ì´ì…˜ì— ê°€ì¥ ì í•©í•œ íŒ¨í„´ì„ ì°¾ê¸° ìœ„í•´ ì—°êµ¬í•˜ëŠ” ê²ƒì´ ì¢‹ìŠµë‹ˆë‹¤.
> - Next.jsì˜ ë³´ì•ˆ ëª¨ë²” ì‚¬ë¡€ì— ëŒ€í•´ ìì„¸íˆ ì•Œì•„ë³´ë ¤ë©´ [Next.js ì„œë²„ ì»´í¬ë„ŒíŠ¸ ì•¡ì…˜ì˜ ë³´ì•ˆ](/blog/security-nextjs-server-components-actions) ê¸°ì‚¬ë¥¼ ì°¸ê³ í•˜ì„¸ìš”.

### Server Components

ì—­í•  ê¸°ë°˜ ì ‘ê·¼ì— ìœ ìš©í•œ [Server Components](/docs/app/building-your-application/rendering/server-components)ì—ì„œ ì¸ì¦ ê²€ì‚¬ë¥¼ ìˆ˜í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì˜ˆë¥¼ ë“¤ì–´, ì‚¬ìš©ìì˜ ì—­í• ì— ë”°ë¼ ì»´í¬ë„ŒíŠ¸ë¥¼ ì¡°ê±´ë¶€ë¡œ ë Œë”ë§í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:

```tsx filename="app/dashboard/page.tsx" switcher
import { verifySession } from "@/app/lib/dal";

export default function Dashboard() {
  const session = await verifySession();
  const userRole = session?.user?.role; // 'role'ì´ ì„¸ì…˜ ê°ì²´ì˜ ì¼ë¶€ë¼ê³  ê°€ì •

  if (userRole === "admin") {
    return <AdminDashboard />;
  } else if (userRole === "user") {
    return <UserDashboard />;
  } else {
    redirect("/login");
  }
}
```

```jsx filename="app/dashboard/page.jsx" switcher
import { verifySession } from '@/app/lib/dal'

export default function Dashboard() {
  const session = await verifySession()
  const userRole = session.role // 'role'ì´ ì„¸ì…˜ ê°ì²´ì˜ ì¼ë¶€ë¼ê³  ê°€ì •

  if (userRole === 'admin') {
    return <AdminDashboard />
  } else if (userRole === 'user') {
    return <UserDashboard />
  } else {
    redirect('/login')
  }
}
```

ì´ ì˜ˆì œì—ì„œëŠ” `verifySession()` í•¨ìˆ˜ë¥¼ ì‚¬ìš©í•˜ì—¬ 'admin', 'user' ë° ì¸ì¦ë˜ì§€ ì•Šì€ ì—­í• ì„ í™•ì¸í•©ë‹ˆë‹¤. ì´ íŒ¨í„´ì€ ê° ì‚¬ìš©ìê°€ ìì‹ ì˜ ì—­í• ì— ì í•©í•œ ì»´í¬ë„ŒíŠ¸ì™€ ìƒí˜¸ ì‘ìš©í•˜ë„ë¡ ë³´ì¥í•©ë‹ˆë‹¤.

### Layoutsì™€ ì¸ì¦ ê²€ì‚¬

[Partial Rendering](/docs/app/building-your-application/routing/linking-and-navigating#4-partial-rendering) ë•Œë¬¸ì—, [Layouts](/docs/app/building-your-application/routing/layouts-and-templates)ì—ì„œ ì¸ì¦ ê²€ì‚¬ë¥¼ ìˆ˜í–‰í•  ë•Œ ì£¼ì˜í•´ì•¼ í•©ë‹ˆë‹¤. ì´ëŠ” íƒìƒ‰ ì‹œ ë ˆì´ì•„ì›ƒì´ ë‹¤ì‹œ ë Œë”ë§ë˜ì§€ ì•Šìœ¼ë¯€ë¡œ ì‚¬ìš©ìì˜ ì„¸ì…˜ì´ ë§¤ë²ˆ í™•ì¸ë˜ì§€ ì•Šê¸° ë•Œë¬¸ì…ë‹ˆë‹¤.

ëŒ€ì‹  ë°ì´í„° ì†ŒìŠ¤ë‚˜ ì¡°ê±´ë¶€ë¡œ ë Œë”ë§í•  ì»´í¬ë„ŒíŠ¸ì— ê°€ê¹Œìš´ ê³³ì—ì„œ ê²€ì‚¬ë¥¼ ìˆ˜í–‰í•´ì•¼ í•©ë‹ˆë‹¤.

ì˜ˆë¥¼ ë“¤ì–´, ì‚¬ìš©ì ë°ì´í„°ë¥¼ ê°€ì ¸ì™€ ë„¤ë¹„ê²Œì´ì…˜ì— ì‚¬ìš©ì ì´ë¯¸ì§€ë¥¼ í‘œì‹œí•˜ëŠ” ê³µìœ  ë ˆì´ì•„ì›ƒì„ ê³ ë ¤í•´ ë³´ì„¸ìš”. ë ˆì´ì•„ì›ƒì—ì„œ ì¸ì¦ ê²€ì‚¬ë¥¼ ìˆ˜í–‰í•˜ëŠ” ëŒ€ì‹ , ë ˆì´ì•„ì›ƒì—ì„œ ì‚¬ìš©ì ë°ì´í„°ë¥¼ ê°€ì ¸ì™€(`getUser()`) DALì—ì„œ ì¸ì¦ ê²€ì‚¬ë¥¼ ìˆ˜í–‰í•´ì•¼ í•©ë‹ˆë‹¤.

ì´ë ‡ê²Œ í•˜ë©´ ì• í”Œë¦¬ì¼€ì´ì…˜ ë‚´ì—ì„œ `getUser()`ê°€ í˜¸ì¶œë˜ëŠ” ê³³ë§ˆë‹¤ ì¸ì¦ ê²€ì‚¬ê°€ ìˆ˜í–‰ë˜ì–´, ì‚¬ìš©ìê°€ ë°ì´í„°ì— ì ‘ê·¼í•  ê¶Œí•œì´ ìˆëŠ”ì§€ í™•ì¸í•˜ëŠ” ê²ƒì„ ê°œë°œìê°€ ìŠì§€ ì•Šë„ë¡ ë°©ì§€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

```tsx filename="app/layout.tsx" switcher
export default async function Layout({
  children,
}: {
  children: React.ReactNode;
}) {
  const user = await getUser();

  return (
    // ...
  )
}
```

```jsx filename="app/layout.js" switcher
export default async function Layout({ children }) {
  const user = await getUser();

  return (
    // ...
  )
}
```

```ts filename="app/lib/dal.ts" switcher
export const getUser = cache(async () => {
  const session = await verifySession();
  if (!session) return null;

  // ì„¸ì…˜ì—ì„œ ì‚¬ìš©ì IDë¥¼ ê°€ì ¸ì™€ ë°ì´í„° í˜ì¹˜
});
```

```js filename="app/lib/dal.js" switcher
export const getUser = cache(async () => {
  const session = await verifySession();
  if (!session) return null;

  // ì„¸ì…˜ì—ì„œ ì‚¬ìš©ì IDë¥¼ ê°€ì ¸ì™€ ë°ì´í„° í˜ì¹˜
});
```

> **ì•Œì•„ë‘ë©´ ì¢‹ì€ ì •ë³´:**
>
> - SPAì—ì„œ ì¼ë°˜ì ì¸ íŒ¨í„´ì€ ì‚¬ìš©ìê°€ ì¸ì¦ë˜ì§€ ì•Šì€ ê²½ìš° ë ˆì´ì•„ì›ƒì´ë‚˜ ìµœìƒìœ„ ì»´í¬ë„ŒíŠ¸ì—ì„œ `null`ì„ ë°˜í™˜í•˜ëŠ” ê²ƒì…ë‹ˆë‹¤. ì´ íŒ¨í„´ì€ Next.js ì• í”Œë¦¬ì¼€ì´ì…˜ì—ëŠ” ê¶Œì¥ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤. Next.js ì• í”Œë¦¬ì¼€ì´ì…˜ì—ëŠ” ì—¬ëŸ¬ ì§„ì…ì ì´ ìˆìœ¼ë¯€ë¡œ, ì´ëŠ” ì¤‘ì²©ëœ ê²½ë¡œ ì„¸ê·¸ë¨¼íŠ¸ ë° ì„œë²„ ì•¡ì…˜ì— ì ‘ê·¼í•˜ëŠ” ê²ƒì„ ë°©ì§€í•˜ì§€ ëª»í•©ë‹ˆë‹¤.

### Server Actions

[Server Actions](/docs/app/building-your-application/data-fetching/server-actions-and-mutations)ë¥¼ ê³µìš© API ì—”ë“œí¬ì¸íŠ¸ì™€ ë™ì¼í•œ ë³´ì•ˆ ê³ ë ¤ ì‚¬í•­ìœ¼ë¡œ ì²˜ë¦¬í•˜ê³ , ì‚¬ìš©ìê°€ ë³€í˜•ì„ ìˆ˜í–‰í•  ìˆ˜ ìˆëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”.

ë‹¤ìŒ ì˜ˆì œì—ì„œëŠ” ì•¡ì…˜ì„ ì§„í–‰í•˜ê¸° ì „ì— ì‚¬ìš©ìì˜ ì—­í• ì„ í™•ì¸í•©ë‹ˆë‹¤:

```ts filename="app/lib/actions.ts" switcher
"use server";
import { verifySession } from "@/app/lib/dal";

export async function serverAction(formData: FormData) {
  const session = await verifySession();
  const userRole = session?.user?.role;

  // ì‚¬ìš©ìê°€ ì•¡ì…˜ì„ ìˆ˜í–‰í•  ê¶Œí•œì´ ì—†ëŠ” ê²½ìš° ì¡°ê¸° ë°˜í™˜
  if (userRole !== "admin") {
    return null;
  }

  // ê¶Œí•œì´ ìˆëŠ” ì‚¬ìš©ìì˜ ê²½ìš° ì•¡ì…˜ ì§„í–‰
}
```

```js filename="app/lib/actions.js" switcher
"use server";
import { verifySession } from "@/app/lib/dal";

export async function serverAction() {
  const session = await verifySession();
  const userRole = session.user.role;

  // ì‚¬ìš©ìê°€ ì•¡ì…˜ì„ ìˆ˜í–‰í•  ê¶Œí•œì´ ì—†ëŠ” ê²½ìš° ì¡°ê¸° ë°˜í™˜
  if (userRole !== "admin") {
    return null;
  }

  // ê¶Œí•œì´ ìˆëŠ” ì‚¬ìš©ìì˜ ê²½ìš° ì•¡ì…˜ ì§„í–‰
}
```

### Route Handlers

[Route Handlers](/docs/app/building-your-application/routing/route-handlers)ë¥¼ ê³µìš© API ì—”ë“œí¬ì¸íŠ¸ì™€ ë™ì¼í•œ ë³´ì•ˆ ê³ ë ¤ ì‚¬í•­ìœ¼ë¡œ ì²˜ë¦¬í•˜ê³ , ì‚¬ìš©ìê°€ Route Handlerì— ì ‘ê·¼í•  ìˆ˜ ìˆëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”.

ì˜ˆë¥¼ ë“¤ì–´:

```ts filename="app/api/route.ts" switcher
import { verifySession } from "@/app/lib/dal";

export async function GET() {
  // ì‚¬ìš©ì ì¸ì¦ ë° ì—­í•  í™•ì¸
  const session = await verifySession();

  // ì‚¬ìš©ìê°€ ì¸ì¦ë˜ì—ˆëŠ”ì§€ í™•ì¸
  if (!session) {
    // ì‚¬ìš©ìê°€ ì¸ì¦ë˜ì§€ ì•ŠìŒ
    return new Response(null, { status: 401 });
  }

  // ì‚¬ìš©ìê°€ 'admin' ì—­í• ì„ ê°€ì§€ê³  ìˆëŠ”ì§€ í™•ì¸
  if (session.user.role !== "admin") {
    // ì‚¬ìš©ìëŠ” ì¸ì¦ë˜ì—ˆì§€ë§Œ ê¶Œí•œì´

    ì—†ìŒ;
    return new Response(null, { status: 403 });
  }

  // ê¶Œí•œì´ ìˆëŠ” ì‚¬ìš©ìì˜ ê²½ìš° ê³„ì† ì§„í–‰
}
```

```js filename="app/api/route.js" switcher
import { verifySession } from "@/app/lib/dal";

export async function GET() {
  // ì‚¬ìš©ì ì¸ì¦ ë° ì—­í•  í™•ì¸
  const session = await verifySession();

  // ì‚¬ìš©ìê°€ ì¸ì¦ë˜ì—ˆëŠ”ì§€ í™•ì¸
  if (!session) {
    // ì‚¬ìš©ìê°€ ì¸ì¦ë˜ì§€ ì•ŠìŒ
    return new Response(null, { status: 401 });
  }

  // ì‚¬ìš©ìê°€ 'admin' ì—­í• ì„ ê°€ì§€ê³  ìˆëŠ”ì§€ í™•ì¸
  if (session.user.role !== "admin") {
    // ì‚¬ìš©ìëŠ” ì¸ì¦ë˜ì—ˆì§€ë§Œ ê¶Œí•œì´ ì—†ìŒ
    return new Response(null, { status: 403 });
  }

  // ê¶Œí•œì´ ìˆëŠ” ì‚¬ìš©ìì˜ ê²½ìš° ê³„ì† ì§„í–‰
}
```

ìœ„ ì˜ˆì œëŠ” ë‘ ë‹¨ê³„ì˜ ë³´ì•ˆ ê²€ì‚¬ë¥¼ í¬í•¨í•œ Route Handlerë¥¼ ë³´ì—¬ì¤ë‹ˆë‹¤. ë¨¼ì € í™œì„± ì„¸ì…˜ì´ ìˆëŠ”ì§€ í™•ì¸í•œ ë‹¤ìŒ, ë¡œê·¸ì¸í•œ ì‚¬ìš©ìê°€ 'admin'ì¸ì§€ í™•ì¸í•©ë‹ˆë‹¤.

## Context Providers

ì¸ì¦ ì‘ì—…ì„ ìœ„í•œ ì»¨í…ìŠ¤íŠ¸ í”„ë¡œë°”ì´ë”ëŠ” [interleaving](/docs/app/building-your-application/rendering/composition-patterns#interleaving-server-and-client-components)ë¡œ ì¸í•´ ì‘ë™í•©ë‹ˆë‹¤. ê·¸ëŸ¬ë‚˜ React `context`ëŠ” Server Componentsì—ì„œ ì§€ì›ë˜ì§€ ì•Šìœ¼ë¯€ë¡œ Client Componentsì—ë§Œ ì ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ì´ëŠ” ì‘ë™í•˜ì§€ë§Œ ìì‹ Server ComponentsëŠ” ë¨¼ì € ì„œë²„ì—ì„œ ë Œë”ë§ë˜ë©° ì»¨í…ìŠ¤íŠ¸ í”„ë¡œë°”ì´ë”ì˜ ì„¸ì…˜ ë°ì´í„°ì— ì ‘ê·¼í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤:

```tsx filename="app/layout.ts" switcher
import { ContextProvider } from "auth-lib";

export default function RootLayout({ children }) {
  return (
    <html lang="en">
      <body>
        <ContextProvider>{children}</ContextProvider>
      </body>
    </html>
  );
}
```

```tsx filename="app/ui/profile.ts" switcher
"use client";

import { useSession } from "auth-lib";

export default function Profile() {
  const { userId } = useSession();
  const { data } = useSWR(`/api/user/${userId}`, fetcher)

  return (
    // ...
  );
}
```

```jsx filename="app/ui/profile.js" switcher
"use client";

import { useSession } from "auth-lib";

export default function Profile() {
  const { userId } = useSession();
  const { data } = useSWR(`/api/user/${userId}`, fetcher)

  return (
    // ...
  );
}
```

í´ë¼ì´ì–¸íŠ¸ ì»´í¬ë„ŒíŠ¸ì—ì„œ ì„¸ì…˜ ë°ì´í„°ê°€ í•„ìš”í•œ ê²½ìš° (ì˜ˆ: í´ë¼ì´ì–¸íŠ¸ ì¸¡ ë°ì´í„° í˜ì¹˜) Reactì˜ [`taintUniqueValue`](https://react.dev/reference/react/experimental_taintUniqueValue) APIë¥¼ ì‚¬ìš©í•˜ì—¬ ë¯¼ê°í•œ ì„¸ì…˜ ë°ì´í„°ê°€ í´ë¼ì´ì–¸íŠ¸ì— ë…¸ì¶œë˜ì§€ ì•Šë„ë¡ í•˜ì„¸ìš”.

</AppOnly>

<PagesOnly>

### Creating a Data Access Layer (DAL)

#### Protecting API Routes

Next.jsì—ì„œ API RoutesëŠ” ì„œë²„ ì¸¡ ë¡œì§ê³¼ ë°ì´í„° ê´€ë¦¬ë¥¼ ì²˜ë¦¬í•˜ëŠ” ë° í•„ìˆ˜ì ì…ë‹ˆë‹¤. ì´ëŸ¬í•œ ë¼ìš°íŠ¸ë¥¼ ë³´ì•ˆí•˜ëŠ” ê²ƒì€ íŠ¹ì • ê¸°ëŠ¥ì— ëŒ€í•œ ì ‘ê·¼ ê¶Œí•œì´ ìˆëŠ” ì‚¬ìš©ìë§Œì´ ì´ë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆë„ë¡ ë³´ì¥í•˜ëŠ” ë° ì¤‘ìš”í•©ë‹ˆë‹¤. ì¼ë°˜ì ìœ¼ë¡œ ì‚¬ìš©ìì˜ ì¸ì¦ ìƒíƒœì™€ ì—­í•  ê¸°ë°˜ ê¶Œí•œì„ í™•ì¸í•˜ëŠ” ì‘ì—…ì´ í¬í•¨ë©ë‹ˆë‹¤.

ë‹¤ìŒì€ API Routeë¥¼ ë³´í˜¸í•˜ëŠ” ì˜ˆì œì…ë‹ˆë‹¤:

```ts filename="pages/api/route.ts" switcher
import { NextApiRequest, NextApiResponse } from "next";

export default async function handler(
  req: NextApiRequest,
  res: NextApiResponse
) {
  const session = await getSession(req);

  // ì‚¬ìš©ìê°€ ì¸ì¦ë˜ì—ˆëŠ”ì§€ í™•ì¸
  if (!session) {
    res.status(401).json({
      error: "User is not authenticated",
    });
    return;
  }

  // ì‚¬ìš©ìê°€ 'admin' ì—­í• ì„ ê°€ì§€ê³  ìˆëŠ”ì§€ í™•ì¸
  if (session.user.role !== "admin") {
    res.status(401).json({
      error: "Unauthorized access: User does not have admin privileges.",
    });
    return;
  }

  // ê¶Œí•œì´ ìˆëŠ” ì‚¬ìš©ìì— ëŒ€í•´ ë¼ìš°íŠ¸ ê³„ì† ì§„í–‰
  // ... API Route êµ¬í˜„
}
```

```js filename="pages/api/route.js" switcher
export default async function handler(req, res) {
  const session = await getSession(req);

  // ì‚¬ìš©ìê°€ ì¸ì¦ë˜ì—ˆëŠ”ì§€ í™•ì¸
  if (!session) {
    res.status(401).json({
      error: "User is not authenticated",
    });
    return;
  }

  // ì‚¬ìš©ìê°€ 'admin' ì—­í• ì„ ê°€ì§€ê³  ìˆëŠ”ì§€ í™•ì¸
  if (session.user.role !== "admin") {
    res.status(401).json({
      error: "Unauthorized access: User does not have admin privileges.",
    });
    return;
  }

  // ê¶Œí•œì´ ìˆëŠ” ì‚¬ìš©ìì— ëŒ€í•´ ë¼ìš°íŠ¸ ê³„ì† ì§„í–‰
  // ... API Route êµ¬í˜„
}
```

ì´ ì˜ˆì œëŠ” ì¸ì¦ ë° ê¶Œí•œ ë¶€ì—¬ì— ëŒ€í•œ ë‘ ë‹¨ê³„ì˜ ë³´ì•ˆ ê²€ì‚¬ë¥¼ í¬í•¨í•œ API Routeë¥¼ ë³´ì—¬ì¤ë‹ˆë‹¤. ë¨¼ì € í™œì„± ì„¸ì…˜ì´ ìˆëŠ”ì§€ í™•ì¸í•œ ë‹¤ìŒ, ë¡œê·¸ì¸í•œ ì‚¬ìš©ìê°€ 'admin'ì¸ì§€ í™•ì¸í•©ë‹ˆë‹¤. ì´ ì ‘ê·¼ ë°©ì‹ì€ ì¸ì¦ë˜ê³  ê¶Œí•œì´ ë¶€ì—¬ëœ ì‚¬ìš©ìì—ê²Œë§Œ ì ‘ê·¼ì„ ì œí•œí•˜ì—¬ ìš”ì²­ ì²˜ë¦¬ì— ëŒ€í•œ ê²¬ê³ í•œ ë³´ì•ˆì„ ìœ ì§€í•©ë‹ˆë‹¤.

</PagesOnly>

## Resources

Next.jsì—ì„œ ì¸ì¦ì— ëŒ€í•´ ë°°ìš´ í›„, ë³´ì•ˆ ì¸ì¦ ë° ì„¸ì…˜ ê´€ë¦¬ë¥¼ êµ¬í˜„í•˜ëŠ” ë° ë„ì›€ì´ ë˜ëŠ” Next.js í˜¸í™˜ ë¼ì´ë¸ŒëŸ¬ë¦¬ì™€ ë¦¬ì†ŒìŠ¤ë¥¼ ì†Œê°œí•©ë‹ˆë‹¤:

### Auth Libraries

- [Auth0](https://auth0.com/docs/quickstart/webapp/nextjs/01-login)
- [Clerk](https://clerk.com/docs/quickstarts/nextjs)
- [Kinde](https://kinde.com/docs/developer-tools/nextjs-sdk)
- [Lucia](https://lucia-auth.com/getting-started/nextjs-app)
- [NextAuth.js](https://authjs.dev/getting-started/installation?framework=next.js)
- [Supabase](https://supabase.com/docs/guides/getting-started/quickstarts/nextjs)
- [Stytch](https://stytch.com/docs/guides/quickstarts/nextjs)
- [WorkOS](https://workos.com/docs/user-management)

### Session Management Libraries

- [Iron Session](https://github.com/vvo/iron-session)
- [Jose](https://github.com/panva/jose)

## Further Reading

ì¸ì¦ ë° ë³´ì•ˆì— ëŒ€í•´ ê³„ì†í•´ì„œ ë°°ìš°ê¸° ìœ„í•´ ë‹¤ìŒ ë¦¬ì†ŒìŠ¤ë¥¼ ì°¸ê³ í•˜ì„¸ìš”:

- [Next.jsì˜ ë³´ì•ˆì— ëŒ€í•´ ìƒê°í•˜ëŠ” ë°©ë²•](/blog/security-nextjs-server-components-actions)
- [XSS ê³µê²© ì´í•´í•˜ê¸°](https://vercel.com/guides/understanding-xss-attacks)
- [CSRF ê³µê²© ì´í•´í•˜ê¸°](https://vercel.com/guides/understanding-csrf-attacks)
- [The Copenhagen Book](https://thecopenhagenbook.com/)
